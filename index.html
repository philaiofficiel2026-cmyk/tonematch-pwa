<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0711" />
  <title>ToneMatch AI</title>
  <style>
    :root{
      --bg0:#05030a;
      --bg1:#0b0711;
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --r:22px;
      --pad:18px;
      --btnh:54px;
      --pink:#ff17b7;
      --violet:#7a2cff;
      --danger:#ff4b4b;
      --ok:#2ee59d;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1100px 650px at 25% 15%, rgba(255,23,183,.22), transparent 55%),
        radial-gradient(950px 650px at 75% 30%, rgba(122,44,255,.22), transparent 55%),
        radial-gradient(900px 650px at 50% 80%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100%;
      padding: calc(16px + var(--safe-top)) 14px calc(18px + var(--safe-bottom));
    }

    .wrap{max-width:980px;margin:0 auto}
    .topbar{
      display:flex;align-items:center;gap:10px;
      padding:12px 8px 18px;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2) 22%, transparent 35%),
                  linear-gradient(135deg, var(--pink), var(--violet));
      box-shadow:0 0 24px rgba(255,23,183,.45);
    }
    .brand{font-weight:900;letter-spacing:.2px;font-size:18px}
    .spacer{flex:1}
    .seg{
      display:inline-flex;border:1px solid var(--stroke);
      border-radius:999px;overflow:hidden;
      background:rgba(255,255,255,.04);
    }
    .seg button{
      height:34px;padding:0 12px;border:0;background:transparent;color:var(--muted);
      font-weight:800;font-size:13px;
    }
    .seg button.on{
      color:var(--text);
      background:linear-gradient(135deg, rgba(255,23,183,.35), rgba(122,44,255,.35));
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: var(--pad);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .hero{display:grid;gap:12px;padding:22px}
    .title{font-size:38px;line-height:1.02;margin:0;font-weight:1000;letter-spacing:-.6px}
    .sub{margin:0;color:var(--muted);font-size:15px;line-height:1.4}

    .actions{display:grid;gap:10px;margin-top:8px}
    .btn{
      height:var(--btnh);
      width:100%;
      border:0;
      border-radius: 16px;
      font-weight:1000;
      font-size:16px;
      color:white;
      background: rgba(255,255,255,.08);
      border:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:center;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .btn.primary{
      background: linear-gradient(90deg, var(--pink), var(--violet));
      border:0;
      box-shadow: 0 14px 45px rgba(255,23,183,.22);
    }
    .btn.primary::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,.22) 45%, transparent 60%);
      transform: translateX(-60%) rotate(10deg);
      opacity:.0;
    }
    .btn.primary.shimmer::after{
      animation: shimmer 1.1s ease-out 1;
      opacity:1;
    }
    @keyframes shimmer{
      0%{transform: translateX(-70%) rotate(10deg); opacity:.0;}
      10%{opacity:1;}
      100%{transform: translateX(80%) rotate(10deg); opacity:0;}
    }

    .btn.danger{
      background: rgba(255,75,75,.18);
      border:1px solid rgba(255,75,75,.35);
      color:#ffd6d6;
    }
    .btn:active{transform:translateY(1px)}
    .stage{margin-top:14px;display:none;gap:12px}

    .imgCard{padding:14px;display:grid;gap:10px}
    .imgWrap{
      border-radius:18px;
      border:1px solid var(--stroke);
      overflow:hidden;
      background:rgba(255,255,255,.04);
      position:relative;
      aspect-ratio: 4 / 3;
      display:flex;align-items:center;justify-content:center;
      touch-action: none; /* important iOS for custom drag */
    }
    .imgWrap img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none; /* keep events on wrapper */
    }

    .crosshair{
      position:absolute;
      width:34px;height:34px;
      left:50%;top:50%;
      transform:translate(-50%,-50%);
      border:2px solid rgba(255,255,255,.88);
      border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.45);
      background:transparent;
      pointer-events:none;
    }
    .crosshair:before,.crosshair:after{
      content:"";
      position:absolute;left:50%;top:50%;
      width:26px;height:2px;background:rgba(255,255,255,.88);
      transform:translate(-50%,-50%);
      border-radius:2px;
    }
    .crosshair:after{width:2px;height:26px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row .btn{flex:1;min-width:210px}

    .swatchPanel{
      border-radius:18px;
      border:1px solid var(--stroke);
      overflow:hidden;
      background:rgba(0,0,0,.18);
    }
    .swRow{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;
      font-weight:1000;
    }
    .tag{display:inline-flex;align-items:center;gap:8px;font-size:13px;font-weight:1000}
    .dotMini{width:12px;height:12px;border-radius:4px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.15)}
    .hexSmall{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-weight:900;font-size:13px;color:rgba(255,255,255,.9)}
    .centerHex{
      padding:18px 12px;
      text-align:center;
      font-size:42px;
      font-weight:1000;
      letter-spacing:1px;
      text-shadow:0 18px 50px rgba(0,0,0,.55);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .swSplit{display:grid;grid-template-rows:auto auto auto}
    .swA{background:rgba(255,255,255,.04)}
    .swCenter{background:rgba(0,0,0,.10)}
    .swB{background:rgba(255,255,255,.04)}
    .barBtns{
      display:flex;gap:10px;
      padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .barBtns .btn{min-width:220px}
    .btn.locked{
      background:rgba(46,229,157,.14)!important;
      border:1px solid rgba(46,229,157,.30)!important;
      color:#dcfff3!important;
    }

    /* Modal */
    .backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      padding: 12px 12px calc(12px + var(--safe-bottom));
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:760px;
      margin:0 auto;
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead h3{margin:0;font-size:18px;font-weight:1000}
    .x{
      width:40px;height:40px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:18px;font-weight:1000;
    }
    .modalBody{padding:14px 16px 16px}
    .sheetBtns{display:grid;gap:10px}

    /* Mes couleurs list */
    .list{
      display:grid;gap:12px;
      max-height: 60vh;
      overflow:auto;
      padding-right:6px;
    }
    .item{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      min-height:112px;
      position:relative;
    }
    .item::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(600px 220px at 15% 20%, rgba(255,23,183,.14), transparent 55%),
                  radial-gradient(600px 220px at 85% 30%, rgba(122,44,255,.12), transparent 60%);
      pointer-events:none;
    }
    .itemSw{
      width:120px;min-width:120px;
      display:flex;flex-direction:column;
      position:relative; z-index:1;
    }
    .itemSw .half{flex:1}
    .itemMain{
      flex:1;
      padding:12px 12px;
      display:flex;flex-direction:column;gap:6px;
      justify-content:center;
      position:relative; z-index:1;
    }
    .itemTitle{font-weight:1000;font-size:18px;line-height:1.1;margin:0}
    .itemSub{margin:0;color:var(--muted);font-weight:900;font-size:13px}
    .itemMeta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted2);font-weight:900;font-size:12px}
    .itemRight{
      display:flex;align-items:center;justify-content:center;
      padding:12px;
      width:120px;min-width:120px;
      border-left:1px solid rgba(255,255,255,.10);
      background:rgba(255,75,75,.10);
      position:relative; z-index:1;
    }
    .itemRight button{
      height:40px;width:100%;
      border-radius:14px;
      border:1px solid rgba(255,75,75,.30);
      background:rgba(255,75,75,.18);
      color:#ffd6d6;
      font-weight:1000;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + var(--safe-bottom));
      transform: translateX(-50%) translateY(22px);
      opacity:0;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      color: rgba(255,255,255,.92);
      padding:12px 14px;
      border-radius: 16px;
      box-shadow: 0 16px 60px rgba(0,0,0,.55);
      font-weight:1000;
      z-index:99999;
      pointer-events:none;
      min-width: 240px;
      text-align:center;
    }
    .toast.show{
      animation: toastIn 1.35s ease-out 1;
    }
    @keyframes toastIn{
      0%{opacity:0; transform: translateX(-50%) translateY(22px);}
      12%{opacity:1; transform: translateX(-50%) translateY(0px);}
      78%{opacity:1; transform: translateX(-50%) translateY(0px);}
      100%{opacity:0; transform: translateX(-50%) translateY(18px);}
    }

    .muted{color:var(--muted)}
    .small{font-size:13px}
    .hide{display:none!important}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <span class="dot"></span>
      <div class="brand">ToneMatch <span class="muted">AI</span></div>
      <div class="spacer"></div>
      <div class="seg" id="modeSeg" title="Mode d‚Äôusage">
        <button type="button" data-mode="vetements" class="on">V√™tements</button>
        <button type="button" data-mode="objets">Objets</button>
      </div>
    </div>

    <!-- HOME -->
    <div class="card hero" id="home">
      <h1 class="title">Identifiez vos couleurs</h1>
      <p class="sub">
        Prenez une photo ou importez une image. D√©placez la cible pour pr√©lever.
        Verrouillez A et B, puis sauvegardez dans <b>Mes couleurs</b>.
      </p>

      <div class="actions">
        <button class="btn primary" id="btnPick">üì∏ <span>Prendre / importer une image</span></button>
        <button class="btn" id="btnColors">üé® <span>Mes couleurs</span></button>
      </div>
    </div>

    <!-- STAGE -->
    <div class="stage" id="stage">
      <div class="card imgCard">
        <div class="imgWrap" id="imgWrap">
          <img id="img" alt="Image s√©lectionn√©e" />
          <div class="crosshair" id="crosshair"></div>
        </div>

        <div class="row">
          <button class="btn" id="btnChangeImg">üñºÔ∏è Changer d‚Äôimage</button>
          <button class="btn" id="btnColors2">üé® Mes couleurs</button>
        </div>

        <div class="swatchPanel" id="swatchPanel">
          <div class="swSplit">
            <div class="swRow swA" id="rowA">
              <div class="tag"><span class="dotMini" id="dotA"></span> A <span class="muted" id="nameA">‚Äî</span></div>
              <div class="hexSmall" id="hexA">‚Äî</div>
            </div>

            <div class="swCenter" id="rowCenter">
              <div class="centerHex" id="hexCenter">‚Äî</div>
            </div>

            <div class="swRow swB" id="rowB">
              <div class="tag"><span class="dotMini" id="dotB"></span> B <span class="muted" id="nameB">‚Äî</span></div>
              <div class="hexSmall" id="hexB">‚Äî</div>
            </div>
          </div>

          <div class="barBtns">
            <button class="btn" id="lockA">üîí Verrouiller A</button>
            <button class="btn" id="lockB">üîí Verrouiller B</button>
            <button class="btn primary" id="saveColors">üíæ Sauvegarder dans Mes couleurs</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FILE INPUTS -->
  <input id="inCamera" type="file" accept="image/*" capture="environment" class="hide" />
  <input id="inPhotos" type="file" accept="image/*" class="hide" />
  <input id="inFiles" type="file" accept="image/*" class="hide" />

  <!-- MODAL: Choisir source -->
  <div class="backdrop" id="bdPick">
    <div class="modal">
      <div class="modalHead">
        <h3>Choisir une source</h3>
        <button class="x" type="button" data-close="bdPick">√ó</button>
      </div>
      <div class="modalBody">
        <div class="sheetBtns">
          <button class="btn primary" type="button" id="pickCamera">üì∏ Cam√©ra</button>
          <button class="btn" type="button" id="pickPhotos">üñºÔ∏è Photos / Galerie</button>
          <button class="btn" type="button" id="pickFiles">üìÅ Fichiers</button>
        </div>
        <p class="small muted" style="margin:12px 2px 0">
          Astuce iPhone : ‚ÄúPhotos / Galerie‚Äù ouvre ton album, ‚ÄúFichiers‚Äù ouvre iCloud/Drive.
        </p>
      </div>
    </div>
  </div>

  <!-- MODAL: Mes couleurs -->
  <div class="backdrop" id="bdColors">
    <div class="modal">
      <div class="modalHead">
        <h3>Mes couleurs</h3>
        <button class="x" type="button" data-close="bdColors">√ó</button>
      </div>
      <div class="modalBody">
        <p class="small muted" style="margin-top:0">
          Historique (max 300). Ajoute autant de combos que tu veux, m√™me depuis la m√™me image.
        </p>
        <div class="list" id="colorsList"></div>
        <div style="margin-top:12px">
          <button class="btn danger" id="resetAll">üóëÔ∏è Tout supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">‚úÖ Sauvegard√© dans Mes couleurs ‚ú®</div>
  <canvas id="cv" class="hide"></canvas>

  <script>
    const $ = (id)=>document.getElementById(id);

    const state = {
      mode: "vetements",
      imgEl: $("img"),
      imgReady: false,
      pos: { x: 0.5, y: 0.5 }, // normalized (0..1) in wrapper
      sample: { r:0,g:0,b:0, hex:"#000000", name:"‚Äî" },
      A: { locked:false, hex:null, name:null, rgb:null },
      B: { locked:false, hex:null, name:null, rgb:null },
    };

    // ---- LocalStorage
    const LS_KEY = "tonematch_mes_couleurs_v3";
    const MAX_HISTORY = 300;

    const loadSaved = ()=> {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
      catch { return []; }
    };
    const saveSaved = (arr)=> localStorage.setItem(LS_KEY, JSON.stringify(arr));

    // ---- Modal helpers
    function openBD(id){ $(id).style.display="flex"; }
    function closeBD(id){ $(id).style.display="none"; }

    document.addEventListener("click",(e)=>{
      const btn = e.target.closest("[data-close]");
      if(btn) closeBD(btn.getAttribute("data-close"));
      if(e.target.classList.contains("backdrop")) e.target.style.display="none";
    });

    // ---- Mode selector
    $("modeSeg").addEventListener("click",(e)=>{
      const b = e.target.closest("button[data-mode]");
      if(!b) return;
      state.mode = b.dataset.mode;
      [...$("modeSeg").querySelectorAll("button")].forEach(x=>x.classList.toggle("on", x===b));
    });

    // ---- Picker modal
    function openPicker(){ openBD("bdPick"); }
    $("btnPick").onclick = openPicker;
    $("btnChangeImg").onclick = openPicker;

    $("pickCamera").onclick = ()=>{ closeBD("bdPick"); $("inCamera").value=""; $("inCamera").click(); };
    $("pickPhotos").onclick = ()=>{ closeBD("bdPick"); $("inPhotos").value=""; $("inPhotos").click(); };
    $("pickFiles").onclick  = ()=>{ closeBD("bdPick"); $("inFiles").value="";  $("inFiles").click();  };

    // ---- File load
    async function onFilePicked(file){
      if(!file) return;
      const url = URL.createObjectURL(file);
      state.imgEl.src = url;

      $("home").style.display = "none";
      $("stage").style.display = "grid";

      state.imgEl.onload = ()=>{
        state.imgReady = true;

        // keep history, but reset locks for new image (UX cleaner)
        state.A.locked = false; state.B.locked=false;
        state.A.hex = null; state.B.hex=null;
        state.pos = { x:0.5, y:0.5 };
        positionCrosshair();

        updateLocksUI();
        sampleNow();
      };
    }

    $("inCamera").addEventListener("change",(e)=> onFilePicked(e.target.files?.[0]));
    $("inPhotos").addEventListener("change",(e)=> onFilePicked(e.target.files?.[0]));
    $("inFiles").addEventListener("change",(e)=> onFilePicked(e.target.files?.[0]));

    // ---- Utils
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    function rgbToHex(r,g,b){
      const to = (n)=> n.toString(16).padStart(2,"0").toUpperCase();
      return "#"+to(r)+to(g)+to(b);
    }

    function rgbToHsl(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h=0,s=0,l=(max+min)/2;
      const d=max-min;
      if(d!==0){
        s = d/(1-Math.abs(2*l-1));
        switch(max){
          case r: h=((g-b)/d)%6; break;
          case g: h=((b-r)/d)+2; break;
          case b: h=((r-g)/d)+4; break;
        }
        h*=60; if(h<0) h+=360;
      }
      return {h, s, l};
    }

    // ---- 300 noms premium (r√©partition par familles, inspir√©es des listes que tu as montr√©es)
    // On ne met pas 300 lignes RGB fixes (lourd). On fait un ‚Äúdictionnaire‚Äù de noms,
    // et on choisit un nom coh√©rent selon Hue + Lightness + Saturation.
    const NAMES = {
      neutrals: [
        "Blanc neige","Blanc lunaire","Blanc cass√©","Ivoire","Coquille d‚Äô≈ìuf","Cr√®me","Lin",
        "Argile","Gris perle","Gris clair","Gris acier","Gris fer","Gris fum√©","Gris ardoise",
        "Anthracite","Noir charbon","Noir de jais","Noir profond","√âb√®ne","R√©glisse"
      ],
      browns: [
        "Sable","Chamois","Beige","Beige clair","Beigeasse","Bistre","Bitume","Cacao","Caf√©",
        "Caf√© au lait","Cannelle","Caramel","Ch√¢taigne","Chaudron","Chocolat","Citrouille",
        "Fauve","Feuille-morte","Gr√®ge","Noisette","Orge br√ªl√©e","Rouille","Tabac",
        "Terre de Sienne","Terre d‚Äôombre","Vanille","Marron","Alezan","Acajou","Ambre","Auburn",
        "Bureau","Brique","Bronze","Brou de noix","Ocre","Ocre jaune","Ocre rouge"
      ],
      reds: [
        "Rouge","√âcarlate","Vermillon","Rouge vif","Rouge cerise","Rouge framboise","Rouge fraise",
        "Rouge grenadine","Rouge carmin","Rouge rubis","Rouge tomate","Rouge coquelicot",
        "Rouge bordeaux","Bordeaux","Rouge bismarck","Rouge sang","Rouge feu","Amarante",
        "Pourpre","Magenta","Magenta fuchsia","Magenta fonc√©","Fuchsia","Rose fuchsia","Rose drag√©e",
        "Rose bonbon","Rose th√©","Rose poudr√©","Nacarat","Incarnat","Grenat","Prune","Bourgogne"
      ],
      oranges: [
        "Orange","Abricot","Aurore","Bis","Bisque","Carotte","Corail","Cuivre","Gomme-gutte",
        "Mandarine","Melon","Orang√©","Orange br√ªl√©e","Roux","Safran","Saumon","Tangerine","Tann√©",
        "Ventre de biche","P√™che","P√™che dor√©e","Orange √©pic√©","Orange solaire"
      ],
      yellows: [
        "Jaune","Beurre","Beurre frais","Blond","Bouton d‚Äôor","Bulle","Caca d‚Äôoie","Champagne",
        "Chrome","Citron","Flave","Fleur de soufre","Jaune aur√©olin","Jaune banane","Jaune canari",
        "Jaune chartreuse","Jaune de Naples","Jaune d‚Äôor","Jaune imp√©rial","Jaune mimosa",
        "Jaune moutarde","Jaune paille","Jaune poussin","Ma√Øs","Miel","Or","Topaze"
      ],
      greens: [
        "Vert primaire","Vert absinthe","Vert amande","Vert anis","Vert avocat","Vert bouteille",
        "Vert d‚Äôeau","Vert √©pinard","Vert gazon","Vert jade","Vert kaki","Vert lime",
        "Vert malachite","Vert menthe","Vert mousse","Vert olive","Vert perroquet","Vert pomme",
        "Vert prairie","Vert sapin","√âmeraude","C√©ladon"
      ],
      blues: [
        "Bleu","Azur","Bleu azur","Bleu ciel","Bleu celeste","Bleu c√©rul√©en","Bleu c√©rul√©um",
        "Bleu cobalt","Bleu de France","Bleu de Berlin","Bleu denim","Bleu √©lectrique",
        "Bleu horizon","Bleu marine","Bleu nuit","Bleu p√©trole","Bleu roi","Bleu saphir",
        "Bleu outremer","Bleu persan","Bleu klein","Aigue-marine","Turquoise","Cyan","Canard",
        "Indigo","Klein","Lapis-lazuli"
      ],
      violets: [
        "Violet","Violet d‚Äô√©v√™que","Violine","Lavande","Pervenche","Mauve","H√©liotrope",
        "Lilas","Prune","Indigo du web","Am√©thyste"
      ]
    };

    function pickFrom(list, t){
      // t in [0..1]
      const i = Math.floor(clamp(t,0,0.9999) * list.length);
      return list[i];
    }

    function colorNameFR(hex, r,g,b){
      const {h,s,l} = rgbToHsl(r,g,b);

      // Neutrals
      if(s < 0.10){
        const t = l; // 0..1
        return pickFrom(NAMES.neutrals, t);
      }

      // Browns/beiges: low saturation + orange/yellow hues
      const inRange = (a,b)=>{
        if(a<=b) return h>=a && h<b;
        return h>=a || h<b;
      };
      const isBrownish = inRange(15, 70) && s < 0.45 && l < 0.78;
      if(isBrownish){
        // map by l (dark->light) and a bit by saturation
        const t = clamp((l*0.75 + s*0.25), 0, 1);
        return pickFrom(NAMES.browns, t);
      }

      // Families
      let family = NAMES.reds;
      if(inRange(345, 15)) family = NAMES.reds;
      else if(inRange(15, 40)) family = NAMES.oranges;
      else if(inRange(40, 70)) family = NAMES.yellows;
      else if(inRange(70, 165)) family = NAMES.greens;
      else if(inRange(165, 255)) family = NAMES.blues;
      else if(inRange(255, 345)) family = NAMES.violets;

      // Within family: use a blended index from lightness and saturation for variety
      const t = clamp(l*0.65 + s*0.35, 0, 1);
      return pickFrom(family, t);
    }

    // ---- Sampling: pixel under crosshair position
    function getDisplayedImageRect(img){
      const wrap = $("imgWrap");
      const W = wrap.clientWidth, H = wrap.clientHeight;
      const iw = img.naturalWidth, ih = img.naturalHeight;
      const scale = Math.max(W/iw, H/ih);   // cover
      const dw = iw*scale, dh = ih*scale;
      const dx = (W - dw)/2;
      const dy = (H - dh)/2;
      return {W,H,iw,ih,scale,dw,dh,dx,dy};
    }

    function sampleAtPosition(px, py){
      const img = state.imgEl;
      if(!state.imgReady) return null;

      const rect = getDisplayedImageRect(img);

      // map container -> source
      const sx = (px - rect.dx) / rect.scale;
      const sy = (py - rect.dy) / rect.scale;

      const x = Math.round(clamp(sx, 0, rect.iw-1));
      const y = Math.round(clamp(sy, 0, rect.ih-1));

      const cv = $("cv");
      const ctx = cv.getContext("2d", { willReadFrequently:true });

      // draw scaled to max 1200px wide
      const maxW = 1200;
      const s2 = Math.min(1, maxW / rect.iw);
      const tw = Math.max(1, Math.round(rect.iw * s2));
      const th = Math.max(1, Math.round(rect.ih * s2));
      cv.width = tw; cv.height = th;
      ctx.clearRect(0,0,tw,th);
      ctx.drawImage(img, 0,0, tw,th);

      const rx = Math.round(x * s2);
      const ry = Math.round(y * s2);

      const data = ctx.getImageData(rx, ry, 1, 1).data;
      return { r:data[0], g:data[1], b:data[2] };
    }

    function positionCrosshair(){
      const wrap = $("imgWrap");
      const ch = $("crosshair");
      const x = state.pos.x * wrap.clientWidth;
      const y = state.pos.y * wrap.clientHeight;
      ch.style.left = x + "px";
      ch.style.top  = y + "px";
    }

    function sampleNow(){
      const wrap = $("imgWrap");
      const px = state.pos.x * wrap.clientWidth;
      const py = state.pos.y * wrap.clientHeight;

      const rgb = sampleAtPosition(px, py);
      if(!rgb) return;

      const hex = rgbToHex(rgb.r,rgb.g,rgb.b);
      const name = colorNameFR(hex, rgb.r,rgb.g,rgb.b);

      state.sample = { ...rgb, hex, name };

      // Live update if unlocked
      if(!state.A.locked){
        state.A.hex = hex; state.A.rgb = rgb; state.A.name = name;
      }
      if(!state.B.locked){
        state.B.hex = hex; state.B.rgb = rgb; state.B.name = name;
      }
      renderSwatches();
    }

    function renderSwatches(){
      $("hexCenter").textContent = state.sample.hex;

      $("hexA").textContent = state.A.hex ? state.A.hex : "‚Äî";
      $("nameA").textContent = state.A.name ? state.A.name : "‚Äî";
      $("rowA").style.background = state.A.hex ? state.A.hex : "rgba(255,255,255,.04)";
      $("dotA").style.background = state.A.hex ? state.A.hex : "rgba(255,255,255,.15)";

      $("rowCenter").style.background = state.sample.hex;

      $("hexB").textContent = state.B.hex ? state.B.hex : "‚Äî";
      $("nameB").textContent = state.B.name ? state.B.name : "‚Äî";
      $("rowB").style.background = state.B.hex ? state.B.hex : "rgba(255,255,255,.04)";
      $("dotB").style.background = state.B.hex ? state.B.hex : "rgba(255,255,255,.15)";

      // auto text for center
      const lum = (rgb)=> (0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b)/255;
      const centerLum = lum(state.sample);
      $("hexCenter").style.color = centerLum > 0.62 ? "rgba(0,0,0,.78)" : "rgba(255,255,255,.92)";
    }

    // ---- Touch/Click pipette (drag & click)
    function enableTouchSampling(){
      const wrap = $("imgWrap");
      let dragging = false;

      function setPosFromClient(clientX, clientY){
        const r = wrap.getBoundingClientRect();
        const x = clamp((clientX - r.left) / r.width, 0, 1);
        const y = clamp((clientY - r.top)  / r.height,0, 1);
        state.pos = {x,y};
        positionCrosshair();
        sampleNow();
      }

      wrap.addEventListener("touchstart", (e)=>{
        if(!state.imgReady) return;
        dragging = true;
        const t = e.touches[0];
        setPosFromClient(t.clientX, t.clientY);
      }, {passive:false});

      wrap.addEventListener("touchmove", (e)=>{
        if(!dragging || !state.imgReady) return;
        e.preventDefault();
        const t = e.touches[0];
        setPosFromClient(t.clientX, t.clientY);
      }, {passive:false});

      wrap.addEventListener("touchend", ()=> dragging = false);
      wrap.addEventListener("touchcancel", ()=> dragging = false);

      wrap.addEventListener("click", (e)=>{
        if(!state.imgReady) return;
        setPosFromClient(e.clientX, e.clientY);
      });

      window.addEventListener("resize", ()=>{
        if(!state.imgReady) return;
        positionCrosshair();
        sampleNow();
      }, {passive:true});
    }

    // ---- Locks
    function updateLocksUI(){
      const a = $("lockA"), b = $("lockB");
      a.classList.toggle("locked", state.A.locked);
      b.classList.toggle("locked", state.B.locked);
      a.textContent = state.A.locked ? "üîì D√©verrouiller A" : "üîí Verrouiller A";
      b.textContent = state.B.locked ? "üîì D√©verrouiller B" : "üîí Verrouiller B";
    }

    $("lockA").onclick = ()=>{
      state.A.locked = !state.A.locked;
      if(!state.A.locked){
        state.A.hex = state.sample.hex;
        state.A.rgb = {r:state.sample.r,g:state.sample.g,b:state.sample.b};
        state.A.name = state.sample.name;
      }
      updateLocksUI(); renderSwatches();
    };

    $("lockB").onclick = ()=>{
      state.B.locked = !state.B.locked;
      if(!state.B.locked){
        state.B.hex = state.sample.hex;
        state.B.rgb = {r:state.sample.r,g:state.sample.g,b:state.sample.b};
        state.B.name = state.sample.name;
      }
      updateLocksUI(); renderSwatches();
    };

    // ---- Colors modal
    function openColors(){
      renderColorsList();
      openBD("bdColors");
    }
    $("btnColors").onclick = openColors;
    $("btnColors2").onclick = openColors;

    function renderColorsList(){
      const list = $("colorsList");
      const saved = loadSaved();
      list.innerHTML = "";

      if(saved.length===0){
        list.innerHTML = `<div class="muted small">Aucune couleur sauvegard√©e pour le moment.</div>`;
        return;
      }

      saved.forEach((it, idx)=>{
        const el = document.createElement("div");
        el.className = "item";

        const sw = document.createElement("div");
        sw.className = "itemSw";

        const half1 = document.createElement("div");
        half1.className = "half";
        half1.style.background = it.a.hex;

        const half2 = document.createElement("div");
        half2.className = "half";
        half2.style.background = it.type==="pair" ? it.b.hex : it.a.hex;

        sw.appendChild(half1);
        sw.appendChild(half2);

        const main = document.createElement("div");
        main.className = "itemMain";

        const t = document.createElement("p");
        t.className = "itemTitle";
        t.textContent = it.type==="single" ? it.a.name : `${it.a.name} + ${it.b.name}`;

        const sub = document.createElement("p");
        sub.className = "itemSub";
        sub.textContent = it.mode === "objets" ? "Objets" : "V√™tements";

        const meta = document.createElement("div");
        meta.className = "itemMeta";
        const d = new Date(it.ts);
        meta.textContent = d.toLocaleDateString("fr-FR", { day:"2-digit", month:"short", year:"numeric" });

        main.appendChild(t);
        main.appendChild(sub);
        main.appendChild(meta);

        const right = document.createElement("div");
        right.className = "itemRight";
        const del = document.createElement("button");
        del.type="button";
        del.textContent="Supprimer";
        del.onclick = ()=>{
          const arr = loadSaved();
          arr.splice(idx,1);
          saveSaved(arr);
          renderColorsList();
        };
        right.appendChild(del);

        el.appendChild(sw);
        el.appendChild(main);
        el.appendChild(right);

        list.appendChild(el);
      });
    }

    $("resetAll").onclick = ()=>{
      if(confirm("Supprimer toutes les couleurs sauvegard√©es ?")){
        saveSaved([]);
        renderColorsList();
      }
    };

    // ---- Premium toast
    let toastTimer = null;
    function showToast(text){
      const t = $("toast");
      t.textContent = text;
      t.classList.remove("show");
      // restart animation
      void t.offsetWidth;
      t.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>t.classList.remove("show"), 1600);
    }

    // ---- Save: keep adding (no overwrite), cap at 300
    $("saveColors").onclick = ()=>{
      if(!state.A.hex || !state.B.hex){
        alert("Verrouille A et B avant de sauvegarder.");
        return;
      }

      const same = (state.A.hex === state.B.hex);

      const entry = same
        ? { type:"single", mode: state.mode, ts: Date.now(), a:{ hex: state.A.hex, name: state.A.name } }
        : { type:"pair", mode: state.mode, ts: Date.now(),
            a:{ hex: state.A.hex, name: state.A.name },
            b:{ hex: state.B.hex, name: state.B.name },
          };

      const saved = loadSaved();
      saved.unshift(entry);
      saveSaved(saved.slice(0, MAX_HISTORY));

      // premium animation
      const btn = $("saveColors");
      btn.classList.add("shimmer");
      setTimeout(()=>btn.classList.remove("shimmer"), 1200);

      showToast("‚úÖ Sauvegard√© dans Mes couleurs ‚ú® ("+Math.min(saved.length, MAX_HISTORY)+"/"+MAX_HISTORY+")");
    };

    // ---- init
    updateLocksUI();
    enableTouchSampling();
  </script>
</body>
</html>