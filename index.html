message : update 
branche : main 
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0711" />
  <title>ToneMatch AI</title>
  <style>
    :root{
      --bg:#07060b;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.45);
      --pink:#ff18b7;
      --violet:#7a2cff;
      --danger:#ff4b4b;
      --ok:#2ee59d;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r: 22px;
      --r2: 16px;
      --pad: 18px;
      --btnh: 52px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%; margin:0; background: radial-gradient(1200px 800px at 20% -10%, rgba(255,24,183,.22), transparent 55%),
                               radial-gradient(1000px 700px at 85% 0%, rgba(122,44,255,.18), transparent 60%),
                               linear-gradient(180deg, #07060b, #07060b 50%, #0a0712);
              color:var(--text); font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial;}
    a{color:inherit}
    .wrap{min-height:100%; padding: calc(14px + var(--safe-top)) 14px calc(16px + var(--safe-bottom)); display:flex; justify-content:center;}
    .app{width:min(520px, 100%);}

    /* Header */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 6px 14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px;}
    .dot{width:12px;height:12px;border-radius:999px;background:linear-gradient(135deg, var(--pink), var(--violet)); box-shadow: 0 0 0 6px rgba(255,24,183,.08);}
    .brand span{font-size:18px}
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding:10px 12px; border-radius:999px;
      display:flex; gap:10px; align-items:center;
      color:var(--muted); font-weight:600; font-size:13px;
    }
    .chip select{
      background:transparent; border:none; outline:none; color:var(--text);
      font-weight:700; font-size:13px; appearance:none;
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero{
      padding: 20px 18px 16px;
      background:
        radial-gradient(800px 340px at 10% -20%, rgba(255,24,183,.24), transparent 60%),
        radial-gradient(800px 340px at 110% 10%, rgba(122,44,255,.18), transparent 60%),
        rgba(255,255,255,.03);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    h1{margin:0 0 6px; font-size:34px; line-height:1.05; letter-spacing:.2px;}
    .sub{margin:0; color:var(--muted); font-size:14px; line-height:1.5}
    .sub b{color:var(--text)}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding: 14px;
    }

    /* Buttons */
    .btn{
      height: var(--btnh);
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-weight:800;
      font-size:16px;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{
      border:none;
      background: linear-gradient(90deg, var(--pink), var(--violet));
      box-shadow: 0 16px 35px rgba(122,44,255,.25), 0 14px 30px rgba(255,24,183,.18);
    }
    .btn.secondary{
      background: rgba(255,255,255,.06);
    }
    .btn.ghost{
      background: transparent;
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-weight:700;
      font-size:14px;
      height: 44px;
      border-radius: 999px;
      justify-content:flex-start;
      padding: 0 14px;
    }
    .btn.small{
      height: 40px;
      font-size:14px;
      font-weight:800;
      border-radius: 14px;
      padding: 0 12px;
    }
    .btn.danger{
      border:none;
      background: rgba(255,75,75,.14);
      color: #ffd8d8;
    }
    .btn.ok{
      border:none;
      background: rgba(46,229,157,.14);
      color: #d7fff0;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .backdrop.show{display:flex;}
    .modal{
      width:min(560px, 100%);
      max-height: min(86vh, 860px);
      overflow:auto;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(20,14,30,.96), rgba(12,9,18,.96));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.7);
    }
    .modal .head{
      position:sticky; top:0;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(25,18,36,.98), rgba(12,9,18,.90));
      backdrop-filter: blur(12px);
      z-index: 2;
    }
    .title{font-size:18px; font-weight:900; letter-spacing:.2px}
    .x{
      width:42px; height:42px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--text);
      font-size:18px; font-weight:900;
      display:grid; place-items:center;
      cursor:pointer;
    }
    .modal .body{padding: 14px;}

    /* Picker view */
    .stage{
      display:grid;
      gap:12px;
    }
    .canvasWrap{
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      position:relative;
    }
    canvas{display:block; width:100%; height:auto; background:#000;}
    .reticle{
      position:absolute;
      width:36px; height:36px; border-radius:999px;
      border:2px solid rgba(255,255,255,.9);
      box-shadow: 0 0 0 10px rgba(0,0,0,.25);
      transform: translate(-50%, -50%);
      pointer-events:none;
    }
    .reticle:before, .reticle:after{
      content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background: rgba(255,255,255,.85);
    }
    .reticle:before{width:16px;height:2px;border-radius:2px;}
    .reticle:after{width:2px;height:16px;border-radius:2px;}

    /* Dual color bar */
    .dual{
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .dual .row{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      font-weight:900;
      letter-spacing:.2px;
      color: rgba(255,255,255,.92);
      gap:12px;
    }
    .dual .row small{font-weight:800; opacity:.9}
    .dual .row .left{display:flex; align-items:center; gap:10px}
    .badge{
      padding:6px 10px; border-radius:999px;
      font-weight:900; font-size:12px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      display:flex; gap:8px; align-items:center;
    }
    .badge .lock{
      width:10px; height:10px; border-radius:3px;
      background: rgba(255,255,255,.85);
      opacity:.9;
    }
    .dual .mid{
      padding: 12px;
      background: rgba(0,0,0,.18);
      border-top:1px solid rgba(255,255,255,.07);
      border-bottom:1px solid rgba(255,255,255,.07);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      font-weight:1000;
      letter-spacing: .7px;
    }
    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
    }
    .meta .pill{
      display:flex; justify-content:space-between; align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      gap:10px;
    }
    .meta b{color:var(--text)}
    .okdot{width:10px;height:10px;border-radius:999px;background:var(--ok); box-shadow: 0 0 0 6px rgba(46,229,157,.10);}
    .warndot{width:10px;height:10px;border-radius:999px;background:#ffd24d; box-shadow: 0 0 0 6px rgba(255,210,77,.10);}

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .actions3{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }

    /* Gallery */
    .list{
      display:grid;
      gap:10px;
    }
    .item{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      overflow:hidden;
      display:grid;
      grid-template-columns: 110px 1fr;
      min-height: 92px;
    }
    .swatch{
      display:grid;
      grid-template-rows: 1fr 1fr;
    }
    .item .info{
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:8px;
    }
    .row2{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .name{font-weight:950; letter-spacing:.2px}
    .tiny{color:var(--muted2); font-size:12px}
    .miniBtns{display:flex; gap:8px; flex-wrap:wrap}

    .hint{color:var(--muted2); font-size:12px; line-height:1.45}
    .divider{height:1px;background:rgba(255,255,255,.10); margin: 10px 0}

    /* Footer spacing */
    .footspace{height: 8px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <div class="topbar">
        <div class="brand"><div class="dot"></div><span>ToneMatch AI</span></div>
        <div class="chip">
          <span>Mode</span>
          <select id="modeSel" aria-label="Mode">
            <option value="vetements">V√™tements</option>
            <option value="objets">Objets</option>
          </select>
        </div>
      </div>

      <div class="card">
        <div class="hero">
          <h1>Identifiez vos couleurs</h1>
          <p class="sub">
            Prenez une photo <b>ou</b> importez une image. Touchez / glissez pour pr√©lever.
            Verrouillez <b>A</b> et <b>B</b> puis sauvegardez dans <b>Mes couleurs</b>.
          </p>
        </div>

        <div class="grid">
          <button class="btn primary" id="openChoiceBtn">üì∏ Prendre / importer une image</button>
          <button class="btn secondary" id="openColorsBtn">üé® Mes couleurs</button>
          <div class="hint" id="modeHint"></div>
        </div>
      </div>

      <div class="footspace"></div>
    </div>
  </div>

  <!-- Modal: Choice -->
  <div class="backdrop" id="choiceBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="head">
        <div class="title">Choisir une source</div>
        <button class="x" data-close="choiceBackdrop">‚úï</button>
      </div>
      <div class="body">
        <button class="btn primary" id="camBtn">üì∑ Cam√©ra</button>
        <div style="height:10px"></div>
        <button class="btn secondary" id="galleryBtn">üñºÔ∏è Galerie / Fichier</button>
        <div class="divider"></div>
        <div class="hint">Astuce iPhone : si on te propose ‚ÄúPrendre une photo‚Äù ou ‚ÄúPhototh√®que‚Äù, choisis ce que tu veux.</div>

        <!-- Hidden inputs -->
        <input id="fileCam" type="file" accept="image/*" capture="environment" hidden />
        <input id="fileAny" type="file" accept="image/*" hidden />
      </div>
    </div>
  </div>

  <!-- Modal: Picker -->
  <div class="backdrop" id="pickerBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="head">
        <div class="title">Pipette couleur</div>
        <button class="x" data-close="pickerBackdrop">‚úï</button>
      </div>
      <div class="body">
        <div class="stage">
          <div class="canvasWrap" id="canvasWrap">
            <canvas id="cv" width="1200" height="900"></canvas>
            <div class="reticle" id="reticle"></div>
          </div>

          <button class="btn ghost" id="changeImgBtn">Changer d‚Äôimage</button>

          <div class="dual" id="dual">
            <div class="row" id="rowA">
              <div class="left">
                <span class="badge"><span class="lock" id="lockAIcon" style="opacity:.25"></span>A</span>
                <small id="aLabel">Non verrouill√©</small>
              </div>
              <small id="aHex">‚Äî</small>
            </div>

            <div class="mid" id="liveHex">#000000</div>

            <div class="row" id="rowB">
              <div class="left">
                <span class="badge"><span class="lock" id="lockBIcon" style="opacity:.25"></span>B</span>
                <small id="bLabel">Non verrouill√©</small>
              </div>
              <small id="bHex">‚Äî</small>
            </div>

            <div class="meta">
              <div class="pill"><span>Qualit√©</span><b id="quality"><span class="warndot"></span>Good</b></div>
              <div class="pill"><span>Nom fun</span><b id="funName">‚Äî</b></div>
            </div>
          </div>

          <div class="actions">
            <button class="btn small secondary" id="lockABtn">üîí Verrouiller A</button>
            <button class="btn small secondary" id="lockBBtn">üîí Verrouiller B</button>
          </div>

          <div class="actions3">
            <button class="btn primary" id="saveBtn">üíæ Sauvegarder dans Mes couleurs</button>
            <button class="btn danger" id="resetBtn">‚Ü∫ R√©initialiser A/B</button>
          </div>

          <div class="hint">
            Glisse ton doigt sur l‚Äôimage. A et B se verrouillent (et ne bougent plus). Tu peux ensuite sauvegarder.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Colors -->
  <div class="backdrop" id="colorsBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="head">
        <div class="title">Mes couleurs</div>
        <button class="x" data-close="colorsBackdrop">‚úï</button>
      </div>
      <div class="body">
        <div class="hint">Ici tu retrouves tes combos A/B. Simple, propre, et supprimable.</div>
        <div class="divider"></div>
        <div class="list" id="colorsList"></div>
        <div class="divider"></div>
        <button class="btn ghost" id="closeColorsBtn">√ó Fermer</button>
      </div>
    </div>
  </div>

  <script>
    // --------- Helpers
    const $ = (id)=>document.getElementById(id);
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const toHex=(r,g,b)=>'#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('').toUpperCase();
    const nowDate=()=>new Date().toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
    const storageKey='tonematch.colors.v1';

    // Fun color names (simple & efficace)
    const FUN = [
      {n:"Noir profond", h:[0,360], s:[0,25], l:[0,18]},
      {n:"Gris fum√©e", h:[0,360], s:[0,18], l:[18,55]},
      {n:"Blanc neige", h:[0,360], s:[0,15], l:[92,100]},
      {n:"Rouge passion", h:[350,20], s:[45,100], l:[30,65]},
      {n:"Rose bonbon", h:[300,345], s:[45,100], l:[45,80]},
      {n:"Violet nuit", h:[255,300], s:[35,100], l:[20,55]},
      {n:"Bleu oc√©an", h:[200,255], s:[35,100], l:[25,60]},
      {n:"Turquoise", h:[165,200], s:[35,100], l:[30,70]},
      {n:"Vert for√™t", h:[95,165], s:[30,100], l:[20,55]},
      {n:"Jaune solaire", h:[40,70], s:[40,100], l:[45,80]},
      {n:"Orange √©pic√©", h:[20,40], s:[45,100], l:[35,70]},
      {n:"Caramel", h:[15,35], s:[25,70], l:[20,45]},
      {n:"Beige sable", h:[25,55], s:[10,40], l:[60,90]},
    ];
    function rgbToHsl(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h=0,s=0,l=(max+min)/2;
      if(max!==min){
        const d=max-min;
        s=l>0.5? d/(2-max-min) : d/(max+min);
        switch(max){
          case r: h=(g-b)/d + (g<b?6:0); break;
          case g: h=(b-r)/d + 2; break;
          case b: h=(r-g)/d + 4; break;
        }
        h*=60;
      }
      return {h, s:s*100, l:l*100};
    }
    function funNameFromRgb(r,g,b){
      const {h,s,l}=rgbToHsl(r,g,b);
      for(const f of FUN){
        const inH = f.h[0] <= f.h[1] ? (h>=f.h[0] && h<=f.h[1]) : (h>=f.h[0] || h<=f.h[1]);
        if(inH && s>=f.s[0] && s<=f.s[1] && l>=f.l[0] && l<=f.l[1]) return f.n;
      }
      return "Teinte unique";
    }

    // --------- UI modals
    function openModal(id){ $(id).classList.add('show'); }
    function closeModal(id){ $(id).classList.remove('show'); }
    document.addEventListener('click', (e)=>{
      const t=e.target;
      if(t?.dataset?.close) closeModal(t.dataset.close);
      if(t.classList.contains('backdrop')) closeModal(t.id);
    });

    // --------- State
    const state = {
      mode: 'vetements',
      img: null,
      a: {locked:false, rgb:null, hex:null, fun:null},
      b: {locked:false, rgb:null, hex:null, fun:null},
      live: {rgb:[0,0,0], hex:'#000000', fun:'‚Äî'},
      pos: {x: 0.5, y: 0.5},
    };

    // --------- Elements
    const modeSel=$('modeSel');
    const modeHint=$('modeHint');

    const openChoiceBtn=$('openChoiceBtn');
    const openColorsBtn=$('openColorsBtn');

    const choiceBackdrop=$('choiceBackdrop');
    const camBtn=$('camBtn');
    const galleryBtn=$('galleryBtn');
    const fileCam=$('fileCam');
    const fileAny=$('fileAny');

    const pickerBackdrop=$('pickerBackdrop');
    const cv=$('cv');
    const ctx=cv.getContext('2d',{ willReadFrequently:true });
    const canvasWrap=$('canvasWrap');
    const reticle=$('reticle');

    const changeImgBtn=$('changeImgBtn');

    const liveHex=$('liveHex');
    const funName=$('funName');
    const quality=$('quality');

    const aLabel=$('aLabel');
    const bLabel=$('bLabel');
    const aHex=$('aHex');
    const bHex=$('bHex');
    const lockAIcon=$('lockAIcon');
    const lockBIcon=$('lockBIcon');

    const lockABtn=$('lockABtn');
    const lockBBtn=$('lockBBtn');
    const saveBtn=$('saveBtn');
    const resetBtn=$('resetBtn');

    const colorsBackdrop=$('colorsBackdrop');
    const colorsList=$('colorsList');
    const closeColorsBtn=$('closeColorsBtn');

    // --------- Mode text
    function refreshModeText(){
      if(state.mode==='vetements'){
        modeHint.textContent = "üëï Id√©al pour assortir un haut, une veste, des baskets‚Ä¶ Ton sur ton en 5 secondes.";
      }else{
        modeHint.textContent = "üè† Parfait pour objets du quotidien : d√©co, peinture, meubles, accessoires‚Ä¶";
      }
    }
    modeSel.addEventListener('change', ()=>{
      state.mode=modeSel.value;
      refreshModeText();
    });
    refreshModeText();

    // --------- Open choice
    openChoiceBtn.onclick=()=>openModal('choiceBackdrop');
    openColorsBtn.onclick=()=>{ renderColors(); openModal('colorsBackdrop'); };

    camBtn.onclick=()=>fileCam.click();
    galleryBtn.onclick=()=>fileAny.click();

    changeImgBtn.onclick=()=>openModal('choiceBackdrop');

    fileCam.addEventListener('change', (e)=>handleFile(e.target.files?.[0]));
    fileAny.addEventListener('change', (e)=>handleFile(e.target.files?.[0]));

    function handleFile(file){
      if(!file) return; // user cancelled -> keep current view
      const reader = new FileReader();
      reader.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          state.img = img;
          drawFit();
          state.pos = {x:0.5,y:0.5};
          sampleAtPos(true);
          closeModal('choiceBackdrop');
          openModal('pickerBackdrop');
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
      // reset input so selecting same file again works
      fileCam.value='';
      fileAny.value='';
    }

    // --------- Canvas render
    function drawFit(){
      const img=state.img;
      if(!img) return;
      // Keep canvas at fixed internal resolution for accuracy
      const W=1200, H=900;
      cv.width=W; cv.height=H;
      ctx.clearRect(0,0,W,H);

      // cover-fit (better for sampling)
      const ir = img.width / img.height;
      const cr = W / H;
      let dw, dh, dx, dy;
      if(ir > cr){ // image wider
        dh = H;
        dw = H * ir;
        dx = (W - dw)/2;
        dy = 0;
      }else{
        dw = W;
        dh = W / ir;
        dx = 0;
        dy = (H - dh)/2;
      }
      ctx.drawImage(img, dx, dy, dw, dh);
    }

    function setReticle(){
      const rect = canvasWrap.getBoundingClientRect();
      const x = rect.left + rect.width * state.pos.x;
      const y = rect.top + rect.height * state.pos.y;
      reticle.style.left = (x - rect.left) + 'px';
      reticle.style.top  = (y - rect.top) + 'px';
    }

    function getPixelAt(x01,y01){
      const x = Math.round(clamp(x01,0,1) * (cv.width-1));
      const y = Math.round(clamp(y01,0,1) * (cv.height-1));
      const d = ctx.getImageData(x,y,1,1).data;
      return [d[0],d[1],d[2]];
    }

    function qualityFromRgb(r,g,b){
      // simple heuristic: very dark or very light = often reliable; mid gray also; very low saturation can be ok.
      const {s,l}=rgbToHsl(r,g,b);
      if(l<18 || l>90) return {label:"Excellent", ok:true};
      if(s<10 && l>25 && l<75) return {label:"Excellent", ok:true};
      return {label:"Good", ok:false};
    }

    function updateDualUI(){
      liveHex.textContent = state.live.hex;
      funName.textContent = state.live.fun;

      // live bar middle color
      liveHex.style.background = `linear-gradient(90deg, rgba(0,0,0,.16), rgba(0,0,0,.16)), ${state.live.hex}`;

      // A row background
      $('rowA').style.background = state.a.locked && state.a.hex ? state.a.hex : 'rgba(255,255,255,.02)';
      $('rowA').style.borderBottom = '1px solid rgba(255,255,255,.06)';
      aHex.textContent = state.a.hex ? state.a.hex : '‚Äî';
      aLabel.textContent = state.a.locked ? (state.a.fun || "A verrouill√©") : "Non verrouill√©";
      lockAIcon.style.opacity = state.a.locked ? .95 : .25;

      // B row background
      $('rowB').style.background = state.b.locked && state.b.hex ? state.b.hex : 'rgba(255,255,255,.02)';
      bHex.textContent = state.b.hex ? state.b.hex : '‚Äî';
      bLabel.textContent = state.b.locked ? (state.b.fun || "B verrouill√©") : "Non verrouill√©";
      lockBIcon.style.opacity = state.b.locked ? .95 : .25;

      const q = qualityFromRgb(...state.live.rgb);
      quality.innerHTML = `${q.ok?'<span class="okdot"></span>':'<span class="warndot"></span>'}${q.label}`;

      // Buttons text (lock/unlock)
      lockABtn.textContent = state.a.locked ? "üîì D√©verrouiller A" : "üîí Verrouiller A";
      lockBBtn.textContent = state.b.locked ? "üîì D√©verrouiller B" : "üîí Verrouiller B";
    }

    function sampleAtPos(force=false){
      if(!state.img) return;
      const rgb = getPixelAt(state.pos.x, state.pos.y);
      const hex = toHex(...rgb);
      const fun = funNameFromRgb(...rgb);
      state.live = {rgb, hex, fun};

      // Important: A/B DO NOT change if locked.
      // Only live changes continuously.
      // (This fixes your ‚Äú√ßa ne verrouille pas‚Äù issue.)
      if(force){
        // nothing special
      }
      updateDualUI();
      setReticle();
    }

    // Pointer interactions
    function posFromEvent(ev){
      const rect = canvasWrap.getBoundingClientRect();
      const cx = (('touches' in ev) ? ev.touches[0].clientX : ev.clientX);
      const cy = (('touches' in ev) ? ev.touches[0].clientY : ev.clientY);
      return {
        x: clamp((cx - rect.left)/rect.width, 0, 1),
        y: clamp((cy - rect.top)/rect.height, 0, 1)
      };
    }

    let dragging=false;
    function startDrag(ev){
      if(!state.img) return;
      dragging=true;
      const p=posFromEvent(ev);
      state.pos=p;
      sampleAtPos(true);
      ev.preventDefault();
    }
    function moveDrag(ev){
      if(!dragging || !state.img) return;
      const p=posFromEvent(ev);
      state.pos=p;
      sampleAtPos();
      ev.preventDefault();
    }
    function endDrag(){ dragging=false; }

    canvasWrap.addEventListener('mousedown', startDrag);
    canvasWrap.addEventListener('mousemove', moveDrag);
    window.addEventListener('mouseup', endDrag);

    canvasWrap.addEventListener('touchstart', startDrag, {passive:false});
    canvasWrap.addEventListener('touchmove', moveDrag, {passive:false});
    window.addEventListener('touchend', endDrag);

    // Lock/unlock
    lockABtn.onclick=()=>{
      if(!state.img) return;
      if(state.a.locked){
        state.a = {locked:false, rgb:null, hex:null, fun:null};
      }else{
        state.a = {locked:true, rgb:[...state.live.rgb], hex: state.live.hex, fun: state.live.fun};
      }
      updateDualUI();
    };
    lockBBtn.onclick=()=>{
      if(!state.img) return;
      if(state.b.locked){
        state.b = {locked:false, rgb:null, hex:null, fun:null};
      }else{
        state.b = {locked:true, rgb:[...state.live.rgb], hex: state.live.hex, fun: state.live.fun};
      }
      updateDualUI();
    };

    resetBtn.onclick=()=>{
      state.a = {locked:false, rgb:null, hex:null, fun:null};
      state.b = {locked:false, rgb:null, hex:null, fun:null};
      updateDualUI();
    };

    // Save
    function loadColors(){
      try{ return JSON.parse(localStorage.getItem(storageKey) || "[]"); }
      catch{ return []; }
    }
    function saveColors(list){
      localStorage.setItem(storageKey, JSON.stringify(list));
    }

    saveBtn.onclick=()=>{
      if(!state.a.locked && !state.b.locked){
        alert("Verrouille au moins A ou B avant de sauvegarder üôÇ");
        return;
      }
      const list = loadColors();

      // Save up to 3 colors max at once -> We store combo A/B (can be same or null)
      const entry = {
        id: crypto?.randomUUID?.() || (Date.now()+""+Math.random()),
        date: nowDate(),
        mode: state.mode,
        aHex: state.a.hex || null,
        bHex: state.b.hex || null,
        aName: state.a.fun || null,
        bName: state.b.fun || null
      };
      list.unshift(entry);
      saveColors(list.slice(0, 60)); // keep clean
      renderColors();
      openModal('colorsBackdrop');
    };

    // Colors list
    function renderColors(){
      const list = loadColors();
      if(!list.length){
        colorsList.innerHTML = `<div class="hint">Aucune couleur sauvegard√©e pour l‚Äôinstant. Fais une photo, verrouille A/B, puis sauvegarde.</div>`;
        return;
      }
      colorsList.innerHTML = list.map(item=>{
        const top = item.aHex || '#1b1626';
        const bot = item.bHex || '#121019';
        const labelA = item.aName || "Couleur A";
        const labelB = item.bName || "Couleur B";
        const modeTxt = item.mode === 'objets' ? 'Objets' : 'V√™tements';
        return `
          <div class="item">
            <div class="swatch">
              <div style="background:${top}"></div>
              <div style="background:${bot}"></div>
            </div>
            <div class="info">
              <div class="row2">
                <div class="name">${labelA}${item.aHex?` <span class="tiny">(${item.aHex})</span>`:""}</div>
                <div class="tiny">${modeTxt}</div>
              </div>
              <div class="row2">
                <div class="name">${labelB}${item.bHex?` <span class="tiny">(${item.bHex})</span>`:""}</div>
                <div class="tiny">${item.date}</div>
              </div>
              <div class="miniBtns">
                <button class="btn small ghost" onclick="navigator.clipboard?.writeText('${(item.aHex||'') + (item.bHex?(' / '+item.bHex):'')}')">üìã Copier</button>
                <button class="btn small danger" onclick="window.__delColor('${item.id}')">Supprimer</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    window.__delColor = (id)=>{
      const list = loadColors().filter(x=>x.id!==id);
      saveColors(list);
      renderColors();
    };

    closeColorsBtn.onclick=()=>closeModal('colorsBackdrop');

    // When opening picker first time without image
    openModalIfNeeded();
    function openModalIfNeeded(){
      // keep clean; nothing
    }

    // Initial list
    renderColors();

    // Resize reticle on show
    const obs = new MutationObserver(()=>{ if(pickerBackdrop.classList.contains('show')) setTimeout(()=>setReticle(), 50); });
    obs.observe(pickerBackdrop, {attributes:true, attributeFilter:['class']});

  </script>
</body>
</html>
