<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0711" />
  <title>ToneMatch AI</title>
  <style>
    :root{
      --bg0:#05030a;
      --bg1:#0b0711;
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --r:22px;
      --pad:18px;
      --btnh:54px;
      --pink:#ff17b7;
      --violet:#7a2cff;
      --danger:#ff4b4b;
      --ok:#2ee59d;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1100px 650px at 25% 15%, rgba(255,23,183,.22), transparent 55%),
        radial-gradient(950px 650px at 75% 30%, rgba(122,44,255,.22), transparent 55%),
        radial-gradient(900px 650px at 50% 80%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100%;
      padding: calc(16px + var(--safe-top)) 14px calc(18px + var(--safe-bottom));
    }

    .wrap{max-width:980px;margin:0 auto}
    .topbar{
      display:flex;align-items:center;gap:10px;
      padding:12px 8px 18px;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2) 22%, transparent 35%),
                  linear-gradient(135deg, var(--pink), var(--violet));
      box-shadow:0 0 24px rgba(255,23,183,.45);
    }
    .brand{font-weight:900;letter-spacing:.2px;font-size:18px}
    .spacer{flex:1}
    .seg{
      display:inline-flex;border:1px solid var(--stroke);
      border-radius:999px;overflow:hidden;
      background:rgba(255,255,255,.04);
    }
    .seg button{
      height:34px;padding:0 12px;border:0;background:transparent;color:var(--muted);
      font-weight:900;font-size:13px;
    }
    .seg button.on{
      color:var(--text);
      background:linear-gradient(135deg, rgba(255,23,183,.35), rgba(122,44,255,.35));
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: var(--pad);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .hero{
      display:grid;gap:12px;
      padding:22px;
    }
    .title{font-size:38px;line-height:1.02;margin:0;font-weight:1000;letter-spacing:-.6px}
    .sub{margin:0;color:var(--muted);font-size:15px;line-height:1.45}

    .actions{display:grid;gap:10px;margin-top:8px}
    .btn{
      height:var(--btnh);
      width:100%;
      border:0;
      border-radius: 16px;
      font-weight:1000;
      font-size:16px;
      color:white;
      background: rgba(255,255,255,.08);
      border:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:center;
      gap:10px;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .btn.primary{
      background: linear-gradient(90deg, var(--pink), var(--violet));
      border:0;
      box-shadow: 0 14px 45px rgba(255,23,183,.22);
    }
    .btn.danger{
      background: rgba(255,75,75,.18);
      border:1px solid rgba(255,75,75,.35);
      color:#ffd6d6;
    }
    .btn:active{transform:translateY(1px)}

    .btn.primary::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,.22) 45%, transparent 60%);
      transform: translateX(-60%) rotate(10deg);
      opacity:0;
    }
    .btn.primary.shimmer::after{
      animation: shimmer 1.1s ease-out 1;
      opacity:1;
    }
    @keyframes shimmer{
      0%{transform: translateX(-70%) rotate(10deg); opacity:0;}
      10%{opacity:1;}
      100%{transform: translateX(80%) rotate(10deg); opacity:0;}
    }

    .stage{
      margin-top:14px;
      display:none;
      gap:12px;
    }

    .imgCard{
      padding:14px;
      display:grid;gap:10px;
    }
    .imgWrap{
      border-radius:18px;
      border:1px solid var(--stroke);
      overflow:hidden;
      background:rgba(255,255,255,.04);
      position:relative;
      aspect-ratio: 4 / 3;
      display:flex;align-items:center;justify-content:center;
      touch-action:none;
    }
    .imgWrap img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
      pointer-events:none;
      user-select:none;
      -webkit-user-drag:none;
    }

    .crosshair{
      position:absolute;
      width:34px;height:34px;
      left:50%;top:50%;
      transform:translate(-50%,-50%);
      border:2px solid rgba(255,255,255,.88);
      border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.45);
      background:transparent;
      pointer-events:none;
    }
    .crosshair:before,.crosshair:after{
      content:"";
      position:absolute;left:50%;top:50%;
      width:26px;height:2px;background:rgba(255,255,255,.88);
      transform:translate(-50%,-50%);
      border-radius:2px;
    }
    .crosshair:after{width:2px;height:26px}

    .row{
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .row .btn{flex:1;min-width:210px}

    .swatchPanel{
      border-radius:18px;
      border:1px solid var(--stroke);
      overflow:hidden;
      background:rgba(0,0,0,.18);
    }
    .swRow{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;
      font-weight:1000;
    }
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      font-size:13px;font-weight:1000;
      color:rgba(255,255,255,.92);
    }
    .dotMini{width:12px;height:12px;border-radius:4px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.15)}
    .hexSmall{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:900;color:rgba(255,255,255,.9);font-size:13px
    }
    .centerHex{
      padding:18px 12px;
      text-align:center;
      font-size:40px;
      font-weight:1000;
      letter-spacing:1px;
      text-shadow:0 18px 50px rgba(0,0,0,.55);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .swSplit{display:grid;grid-template-rows:auto auto auto}
    .swA{background:rgba(255,255,255,.04)}
    .swCenter{background:rgba(0,0,0,.10)}
    .swB{background:rgba(255,255,255,.04)}
    .barBtns{
      display:flex;gap:10px;
      padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .barBtns .btn{min-width:220px}
    .btn.locked{
      background:rgba(46,229,157,.14)!important;
      border:1px solid rgba(46,229,157,.30)!important;
      color:#dcfff3!important;
    }

    /* Modal */
    .backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      padding: 12px 12px calc(12px + var(--safe-bottom));
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:760px;
      margin:0 auto;
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      animation: pop .18s ease-out;
    }
    @keyframes pop{from{transform:translateY(10px);opacity:.6}to{transform:translateY(0);opacity:1}}
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead h3{margin:0;font-size:18px;font-weight:1000}
    .x{
      width:40px;height:40px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:18px;font-weight:1000;
    }
    .modalBody{padding:14px 16px 16px}
    .sheetBtns{display:grid;gap:10px}
    .sheetBtns .btn{min-width:unset}

    /* Mes couleurs list */
    .list{
      display:grid;gap:12px;
      max-height: 60vh;
      overflow:auto;
      padding-right:6px;
    }
    .item{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      min-height:112px;
      position:relative;
    }
    .itemSw{
      width:120px;min-width:120px;
      background:#000;
      position:relative;
    }
    .itemMain{
      flex:1;
      padding:12px 12px;
      display:flex;flex-direction:column;gap:6px;
      justify-content:center;
    }
    .itemTitle{font-weight:1000;font-size:18px;line-height:1.1;margin:0}
    .itemSub{margin:0;color:var(--muted);font-weight:900;font-size:13px}
    .itemMeta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted2);font-weight:900;font-size:12px}
    .itemRight{
      display:flex;align-items:center;justify-content:center;
      padding:12px;
      width:120px;min-width:120px;
      border-left:1px solid rgba(255,255,255,.10);
      background:rgba(255,75,75,.10);
    }
    .itemRight button{
      height:40px;width:100%;
      border-radius:14px;
      border:1px solid rgba(255,75,75,.30);
      background:rgba(255,75,75,.18);
      color:#ffd6d6;
      font-weight:1000;
    }
    .selectPill{
      position:absolute;
      top:10px;left:10px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.28);
      font-weight:1000;
      font-size:12px;
      display:flex;align-items:center;gap:8px;
      color:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .check{
      width:14px;height:14px;border-radius:4px;
      border:1px solid rgba(255,255,255,.35);
      background:rgba(255,255,255,.10);
      display:inline-block;
    }
    .check.on{
      background:rgba(46,229,157,.35);
      border-color: rgba(46,229,157,.7);
      box-shadow:0 0 0 3px rgba(46,229,157,.12);
    }

    /* Compare */
    .compareTop{
      display:grid;gap:10px;margin-bottom:12px;
    }
    .selRow{
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .chip{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      min-width: 220px;
      flex:1;
    }
    .chipSw{
      width:44px;height:44px;border-radius:14px;border:1px solid rgba(255,255,255,.18);
      background:#000;
      flex:none;
    }
    .chipTxt{display:flex;flex-direction:column;gap:4px}
    .chipName{font-weight:1000}
    .chipCode{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:900;color:rgba(255,255,255,.88);font-size:12px
    }

    .pairs{
      display:grid;gap:10px;
    }
    .pair{
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .pairL{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
    }
    .miniSw{width:24px;height:24px;border-radius:8px;border:1px solid rgba(255,255,255,.20)}
    .pairNames{font-weight:1000}
    .pairSmall{color:var(--muted);font-weight:900;font-size:12px}
    .badge{
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      font-weight:1000;
      white-space:nowrap;
    }

    /* helper */
    .muted{color:var(--muted)}
    .small{font-size:13px}
    .hide{display:none!important}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + var(--safe-bottom));
      transform: translateX(-50%) translateY(22px);
      opacity:0;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      color: rgba(255,255,255,.92);
      padding:12px 14px;
      border-radius: 16px;
      box-shadow: 0 16px 60px rgba(0,0,0,.55);
      font-weight:1000;
      z-index:99999;
      pointer-events:none;
      min-width: 240px;
      text-align:center;
    }
    .toast.show{animation: toastIn 1.35s ease-out 1;}
    @keyframes toastIn{
      0%{opacity:0; transform: translateX(-50%) translateY(22px);}
      12%{opacity:1; transform: translateX(-50%) translateY(0px);}
      78%{opacity:1; transform: translateX(-50%) translateY(0px);}
      100%{opacity:0; transform: translateX(-50%) translateY(18px);}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <span class="dot"></span>
      <div class="brand">ToneMatch <span class="muted">AI</span></div>
      <div class="spacer"></div>

      <div class="seg" id="modeSeg" title="Mode d‚Äôusage">
        <button type="button" data-mode="vetements" class="on">V√™tements</button>
        <button type="button" data-mode="objets">Objets</button>
      </div>
    </div>

    <!-- HOME -->
    <div class="card hero" id="home">
      <h1 class="title">Identifiez vos couleurs</h1>
      <p class="sub">
        Prends une photo ou importe une image. D√©place la cible pour pr√©lever.
        Verrouille A et B, puis sauvegarde dans <b>Mes couleurs</b>.
      </p>

      <div class="actions">
        <button class="btn primary" id="btnPick">üì∏ <span>Prendre / importer une image</span></button>
        <button class="btn" id="btnCompare">üß© <span>Comparer</span></button>
        <button class="btn" id="btnColors">üé® <span>Mes couleurs</span></button>
      </div>
    </div>

    <!-- STAGE -->
    <div class="stage" id="stage">
      <div class="card imgCard">
        <div class="imgWrap" id="imgWrap">
          <img id="img" alt="Image s√©lectionn√©e" />
          <div class="crosshair" id="crosshair"></div>
        </div>

        <div class="row">
          <button class="btn" id="btnChangeImg">üñºÔ∏è Changer d‚Äôimage</button>
          <button class="btn" id="btnCompare2">üß© Comparer</button>
          <button class="btn" id="btnColors2">üé® Mes couleurs</button>
        </div>

        <div class="swatchPanel" id="swatchPanel">
          <div class="swSplit">
            <div class="swRow swA" id="rowA">
              <div class="tag"><span class="dotMini" id="dotA"></span> A <span class="muted" id="nameA">‚Äî</span></div>
              <div class="hexSmall" id="hexA">‚Äî</div>
            </div>

            <div class="swCenter" id="rowCenter">
              <div class="centerHex" id="hexCenter">‚Äî</div>
            </div>

            <div class="swRow swB" id="rowB">
              <div class="tag"><span class="dotMini" id="dotB"></span> B <span class="muted" id="nameB">‚Äî</span></div>
              <div class="hexSmall" id="hexB">‚Äî</div>
            </div>
          </div>

          <div class="barBtns">
            <button class="btn" id="lockA">üîí Verrouiller A</button>
            <button class="btn" id="lockB">üîí Verrouiller B</button>
            <button class="btn primary" id="saveColors">üíæ Sauvegarder dans Mes couleurs</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FILE INPUTS -->
  <input id="inCamera" type="file" accept="image/*" capture="environment" class="hide" />
  <input id="inPhotos" type="file" accept="image/*" class="hide" />
  <input id="inFiles" type="file" accept="image/*" class="hide" />

  <!-- MODAL: Choisir source -->
  <div class="backdrop" id="bdPick">
    <div class="modal">
      <div class="modalHead">
        <h3>Choisir une source</h3>
        <button class="x" type="button" data-close="bdPick">√ó</button>
      </div>
      <div class="modalBody">
        <div class="sheetBtns">
          <button class="btn primary" type="button" id="pickCamera">üì∏ Cam√©ra</button>
          <button class="btn" type="button" id="pickPhotos">üñºÔ∏è Photos / Galerie</button>
          <button class="btn" type="button" id="pickFiles">üìÅ Fichiers</button>
        </div>
        <p class="small muted" style="margin:12px 2px 0">
          Astuce iPhone : ‚ÄúPhotos / Galerie‚Äù ouvre ton album, ‚ÄúFichiers‚Äù ouvre iCloud/Drive.
        </p>
      </div>
    </div>
  </div>

  <!-- MODAL: Mes couleurs -->
  <div class="backdrop" id="bdColors">
    <div class="modal">
      <div class="modalHead">
        <h3>Mes couleurs</h3>
        <button class="x" type="button" data-close="bdColors">√ó</button>
      </div>
      <div class="modalBody">
        <p class="small muted" style="margin-top:0">
          Tes couleurs sauvegard√©es (sans doublons). Appuie sur ‚ÄúComparer‚Äù pour v√©rifier le ton sur ton.
        </p>
        <div class="list" id="colorsList"></div>
        <div style="margin-top:12px">
          <button class="btn danger" id="resetAll">üóëÔ∏è Tout supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Comparer -->
  <div class="backdrop" id="bdCompare">
    <div class="modal">
      <div class="modalHead">
        <h3>Comparer</h3>
        <button class="x" type="button" data-close="bdCompare">√ó</button>
      </div>
      <div class="modalBody">
        <div class="compareTop">
          <p class="small muted" style="margin:0">
            S√©lectionne jusqu‚Äô√† <b>4 couleurs</b> depuis ton historique. On calcule la proximit√© (ton sur ton) automatiquement.
          </p>
          <div class="selRow" id="selRow"></div>
        </div>

        <div class="pairs" id="pairs"></div>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="btnPickFromHistory">üé® Choisir dans Mes couleurs</button>
          <button class="btn danger" id="btnClearSelection">üßº R√©initialiser s√©lection</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">‚úÖ</div>
  <canvas id="cv" class="hide"></canvas>

  <script>
    const $ = (id)=>document.getElementById(id);

    const state = {
      mode: "vetements",
      imgEl: $("img"),
      imgReady: false,
      pos: { x: 0.5, y: 0.5 }, // normalized
      sample: { r:0,g:0,b:0, hex:"#000000", name:"‚Äî" },
      A: { locked:false, hex:null, name:null, rgb:null },
      B: { locked:false, hex:null, name:null, rgb:null },
      cache: { ready:false, scale:1, w:0, h:0 },
      compare: { selectedHex: [] } // up to 4
    };

    // ---------------- Toast
    let toastTimer = null;
    function showToast(text){
      const t = $("toast");
      t.textContent = text;
      t.classList.remove("show");
      void t.offsetWidth;
      t.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>t.classList.remove("show"), 1600);
    }

    // ---------------- LocalStorage (unique colors)
    const LS_KEY = "tonematch_unique_colors_v4";
    const MAX_HISTORY = 300;

    const loadSaved = ()=> {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
      catch { return []; }
    };
    const saveSaved = (arr)=> localStorage.setItem(LS_KEY, JSON.stringify(arr));

    function isHexSaved(hex){
      return loadSaved().some(x => x.hex === hex);
    }

    function addColorIfNew(hex, name, rgb){
      const saved = loadSaved();
      if(saved.some(x=>x.hex===hex)) return false;
      saved.unshift({
        hex,
        name,
        rgb, // {r,g,b}
        mode: state.mode,
        ts: Date.now()
      });
      saveSaved(saved.slice(0, MAX_HISTORY));
      return true;
    }

    // ---------------- Modals
    function openBD(id){ $(id).style.display="flex"; }
    function closeBD(id){ $(id).style.display="none"; }

    document.addEventListener("click",(e)=>{
      const btn = e.target.closest("[data-close]");
      if(btn) closeBD(btn.getAttribute("data-close"));
      if(e.target.classList.contains("backdrop")) e.target.style.display="none";
    });

    // ---------------- Mode selector
    $("modeSeg").addEventListener("click",(e)=>{
      const b = e.target.closest("button[data-mode]");
      if(!b) return;
      state.mode = b.dataset.mode;
      [...$("modeSeg").querySelectorAll("button")].forEach(x=>x.classList.toggle("on", x===b));
    });

    // ---------------- Picker
    function openPicker(){ openBD("bdPick"); }
    $("btnPick").onclick = openPicker;
    $("btnChangeImg").onclick = openPicker;

    $("pickCamera").onclick = ()=>{ closeBD("bdPick"); $("inCamera").value=""; $("inCamera").click(); };
    $("pickPhotos").onclick = ()=>{ closeBD("bdPick"); $("inPhotos").value=""; $("inPhotos").click(); };
    $("pickFiles").onclick  = ()=>{ closeBD("bdPick"); $("inFiles").value="";  $("inFiles").click();  };

    async function onFilePicked(file){
      if(!file) return;
      const url = URL.createObjectURL(file);
      state.imgEl.src = url;

      $("home").style.display = "none";
      $("stage").style.display = "grid";

      state.imgEl.onload = ()=>{
        state.imgReady = true;
        state.A.locked=false; state.B.locked=false;
        state.A.hex=null; state.B.hex=null;
        updateLocksUI();

        buildCanvasCache();
        setCrosshair(state.pos.x, state.pos.y);
        sampleNow();
      };
    }

    $("inCamera").addEventListener("change",(e)=> onFilePicked(e.target.files?.[0]));
    $("inPhotos").addEventListener("change",(e)=> onFilePicked(e.target.files?.[0]));
    $("inFiles").addEventListener("change",(e)=> onFilePicked(e.target.files?.[0]));

    function buildCanvasCache(){
      const img = state.imgEl;
      const cv = $("cv");
      const ctx = cv.getContext("2d", { willReadFrequently:true });

      const iw = img.naturalWidth, ih = img.naturalHeight;
      const maxW = 1400;
      const s = Math.min(1, maxW / iw);

      const tw = Math.max(1, Math.round(iw * s));
      const th = Math.max(1, Math.round(ih * s));
      cv.width = tw; cv.height = th;
      ctx.clearRect(0,0,tw,th);
      ctx.drawImage(img, 0,0, tw,th);

      state.cache = { ready:true, scale:s, w:tw, h:th };
    }

    // ---------------- Sampling
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    function getDisplayedImageRect(){
      const wrap = $("imgWrap");
      const W = wrap.clientWidth, H = wrap.clientHeight;
      const iw = state.imgEl.naturalWidth, ih = state.imgEl.naturalHeight;
      const scale = Math.max(W/iw, H/ih);
      const dw = iw*scale, dh = ih*scale;
      const dx = (W - dw)/2;
      const dy = (H - dh)/2;
      return {W,H,iw,ih,scale,dx,dy};
    }

    function sampleAtNormalized(nx, ny){
      if(!state.imgReady || !state.cache.ready) return null;

      const rect = getDisplayedImageRect();
      const cx = rect.W * nx;
      const cy = rect.H * ny;

      const sx = (cx - rect.dx) / rect.scale;
      const sy = (cy - rect.dy) / rect.scale;

      const x = Math.round(clamp(sx, 0, rect.iw-1));
      const y = Math.round(clamp(sy, 0, rect.ih-1));

      const cv = $("cv");
      const ctx = cv.getContext("2d", { willReadFrequently:true });

      const rx = Math.round(x * state.cache.scale);
      const ry = Math.round(y * state.cache.scale);
      const data = ctx.getImageData(rx, ry, 1, 1).data;

      return { r:data[0], g:data[1], b:data[2] };
    }

    function rgbToHex(r,g,b){
      const to = (n)=> n.toString(16).padStart(2,"0").toUpperCase();
      return "#"+to(r)+to(g)+to(b);
    }

    function hexToRgb(hex){
      const h = hex.replace("#","").trim();
      const r = parseInt(h.slice(0,2),16);
      const g = parseInt(h.slice(2,4),16);
      const b = parseInt(h.slice(4,6),16);
      return {r,g,b};
    }

    function rgbToHsl(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h=0,s=0,l=(max+min)/2;
      const d=max-min;
      if(d!==0){
        s = d/(1-Math.abs(2*l-1));
        switch(max){
          case r: h=((g-b)/d)%6; break;
          case g: h=((b-r)/d)+2; break;
          case b: h=((r-g)/d)+4; break;
        }
        h*=60; if(h<0) h+=360;
      }
      return {h, s, l};
    }

    // ---------------- "Biblioth√®que" de noms FR (mix intelligent + garde-fous)
    // But: √©viter les absurdit√©s type "melon" sur du brun/noir.
    // Strat√©gie: 1) neutrals & dark guardrails 2) bruns/beiges 3) familles avec seuils.

    const NAMES = {
      neutrals: [
        "Noir absolu","Noir de jais","Noir profond","√âb√®ne","Anthracite","Ardoise",
        "Gris acier","Gris fum√©","Gris perle","Gris clair","Lin","√âcru","Ivoire","Cr√®me","Blanc cass√©","Blanc neige"
      ],
      browns: [
        "Chocolat noir","Caf√© serr√©","Caf√©","Moka","Cacao","Ch√¢taigne","Noisette",
        "Caramel","Cannelle","Cognac","Tabac","Terre de Sienne","Terre d‚Äôombre",
        "Ocre brun","Brique","Rouille","Sable","Beige sable","Camel","Taupe","Gr√®ge"
      ],
      reds: [
        "Rouge passion","Rouge coquelicot","Rouge cerise","Rouge framboise","Rouge carmin",
        "Rouge rubis","Vermillon","Grenat","Bordeaux","Sang de b≈ìuf","Pourpre"
      ],
      oranges: [
        "Corail","Abricot","P√™che","Mandarine","Orange √©pic√©","Cuivre","Terracotta"
      ],
      yellows: [
        "Jaune citron","Jaune solaire","Jaune mimosa","Miel","Safran","Or"
      ],
      greens: [
        "Vert menthe","Vert d‚Äôeau","Vert sauge","Vert olive","Vert kaki","Vert prairie","Vert √©meraude","Vert sapin"
      ],
      blues: [
        "Bleu ciel","Bleu azur","Bleu denim","Bleu roi","Bleu p√©trole","Bleu canard","Bleu marine","Bleu nuit"
      ],
      violets: [
        "Lavande","Lilas","Mauve","Violet","Am√©thyste","Prune","Fuchsia","Magenta"
      ]
    };

    function pickFrom(list, t){
      const i = Math.floor(clamp(t,0,0.9999) * list.length);
      return list[i];
    }

    function colorNameFR(r,g,b){
      const {h,s,l} = rgbToHsl(r,g,b);

      // Guardrails (tr√®s sombre)
      if(l < 0.10){
        if(s < 0.12) return "Noir absolu";
        if(h>=190 && h<250) return "Noir bleut√©";
        if(h>=250 && h<330) return "Noir violac√©";
        return "Noir profond";
      }
      if(l < 0.18){
        if(s < 0.12) return "Anthracite";
        if(h>=15 && h<65) return "Chocolat noir";
        if(h>=345 || h<15) return "Bordeaux";
        if(h>=190 && h<250) return "Bleu nuit";
        if(h>=250 && h<300) return "Prune";
        return "Sombre intense";
      }

      // Neutres (faible saturation)
      if(s < 0.10){
        // map lightness -> neutrals
        if(l > 0.93) return "Blanc neige";
        if(l > 0.86) return "Blanc cass√©";
        if(l > 0.78) return "Ivoire";
        if(l > 0.70) return "√âcru";
        if(l > 0.60) return "Gris clair";
        if(l > 0.50) return "Gris perle";
        if(l > 0.40) return "Gris fum√©";
        if(l > 0.30) return "Gris acier";
        if(l > 0.22) return "Ardoise";
        return "Anthracite";
      }

      // Bruns/Beiges (teinte orange-jaune + sat mod√©r√©e)
      const inRange = (a,b)=> a<=b ? (h>=a && h<b) : (h>=a || h<b);
      const brownZone = inRange(15, 75);

      if(brownZone){
        // Beige (clair + sat faible/mod√©r√©e)
        if(l > 0.70 && s < 0.40){
          const t = clamp((l-0.70)/0.30, 0, 1);
          return pickFrom(["Cr√®me","Ivoire","Beige sable","Sable","Camel","Taupe","Gr√®ge"], t);
        }
        // Brown (plus sombre)
        if(l < 0.55){
          const t = clamp((0.55-l)/0.37, 0, 1);
          return pickFrom(["Caramel","Cannelle","Cognac","Noisette","Ch√¢taigne","Cacao","Caf√©","Chocolat noir"], t);
        }
      }

      // Families (avec seuils de luminosit√© pour √©viter "Bleu ciel" sur sombre)
      let family = "other";
      if(inRange(345, 15)) family = "red";
      else if(inRange(15, 40)) family = "orange";
      else if(inRange(40, 70)) family = "yellow";
      else if(inRange(70, 165)) family = "green";
      else if(inRange(165, 255)) family = "blue";
      else if(inRange(255, 345)) family = "violet";

      // Qualifiers
      const vivid = s > 0.70;
      const pastel = l > 0.78 && s < 0.45;

      if(family==="blue"){
        if(l > 0.82 && s < 0.55) return "Bleu ciel";
        if(l > 0.70) return vivid ? "Bleu azur" : "Bleu ciel";
        if(l > 0.55) return vivid ? "Bleu roi" : "Bleu denim";
        if(l > 0.40) return "Bleu p√©trole";
        if(l > 0.28) return "Bleu marine";
        return "Bleu nuit";
      }

      if(family==="green"){
        if(l > 0.78 && s < 0.55) return "Vert d‚Äôeau";
        if(l > 0.70) return vivid ? "Vert menthe" : "Vert d‚Äôeau";
        if(l > 0.55) return vivid ? "Vert √©meraude" : "Vert prairie";
        if(l > 0.40) return "Vert olive";
        return "Vert sapin";
      }

      if(family==="red"){
        if(pastel) return "Rose poudr√©";
        if(l < 0.35) return "Bordeaux";
        if(vivid && l > 0.45) return "Rouge passion";
        const t = clamp(l*0.65 + s*0.35, 0, 1);
        return pickFrom(NAMES.reds, t);
      }

      if(family==="orange"){
        if(pastel) return "P√™che";
        if(l < 0.40) return "Terracotta";
        const t = clamp(l*0.60 + s*0.40, 0, 1);
        return pickFrom(NAMES.oranges, t);
      }

      if(family==="yellow"){
        if(pastel) return "Vanille";
        if(l < 0.45) return "Miel";
        const t = clamp(l*0.60 + s*0.40, 0, 1);
        return pickFrom(NAMES.yellows, t);
      }

      if(family==="violet"){
        if(l < 0.40) return "Prune";
        if(pastel) return "Lavande";
        const t = clamp(l*0.55 + s*0.45, 0, 1);
        return pickFrom(NAMES.violets, t);
      }

      // fallback (should be rare)
      return "Teinte √©l√©gante";
    }

    function sampleNow(){
      const rgb = sampleAtNormalized(state.pos.x, state.pos.y);
      if(!rgb) return;

      const hex = rgbToHex(rgb.r,rgb.g,rgb.b);
      const name = colorNameFR(rgb.r,rgb.g,rgb.b);
      state.sample = { ...rgb, hex, name };

      if(!state.A.locked){
        state.A.hex = hex; state.A.rgb = rgb; state.A.name = name;
      }
      if(!state.B.locked){
        state.B.hex = hex; state.B.rgb = rgb; state.B.name = name;
      }

      renderSwatches();
    }

    function renderSwatches(){
      const rgb = state.sample;
      const hex = state.sample.hex;

      $("hexCenter").textContent = hex;

      $("hexA").textContent = state.A.hex ? `${state.A.hex} ‚Ä¢ RGB(${state.A.rgb.r},${state.A.rgb.g},${state.A.rgb.b})` : "‚Äî";
      $("nameA").textContent = state.A.name || "‚Äî";
      $("rowA").style.background = state.A.hex ? state.A.hex : "rgba(255,255,255,.04)";
      $("dotA").style.background = state.A.hex ? state.A.hex : "rgba(255,255,255,.15)";

      $("rowCenter").style.background = hex;

      $("hexB").textContent = state.B.hex ? `${state.B.hex} ‚Ä¢ RGB(${state.B.rgb.r},${state.B.rgb.g},${state.B.rgb.b})` : "‚Äî";
      $("nameB").textContent = state.B.name || "‚Äî";
      $("rowB").style.background = state.B.hex ? state.B.hex : "rgba(255,255,255,.04)";
      $("dotB").style.background = state.B.hex ? state.B.hex : "rgba(255,255,255,.15)";

      const lum = (c)=> (0.2126*c.r + 0.7152*c.g + 0.0722*c.b)/255;
      $("hexCenter").style.color = lum(rgb) > 0.62 ? "rgba(0,0,0,.78)" : "rgba(255,255,255,.92)";
    }

    function setCrosshair(nx, ny){
      state.pos.x = clamp(nx, 0, 1);
      state.pos.y = clamp(ny, 0, 1);
      const wrap = $("imgWrap");
      const ch = $("crosshair");
      ch.style.left = (wrap.clientWidth * state.pos.x) + "px";
      ch.style.top  = (wrap.clientHeight * state.pos.y) + "px";
    }

    function enableTouchSampling(){
      const wrap = $("imgWrap");

      function fromClientXY(clientX, clientY){
        const rect = wrap.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        setCrosshair(x / rect.width, y / rect.height);
        sampleNow();
      }

      wrap.addEventListener("pointerdown", (e)=>{
        if(!state.imgReady) return;
        wrap.setPointerCapture(e.pointerId);
        fromClientXY(e.clientX, e.clientY);
      });

      wrap.addEventListener("pointermove", (e)=>{
        if(!state.imgReady) return;
        if(e.buttons === 0) return;
        fromClientXY(e.clientX, e.clientY);
      });

      wrap.addEventListener("click", (e)=>{
        if(!state.imgReady) return;
        fromClientXY(e.clientX, e.clientY);
      });

      window.addEventListener("resize", ()=>{
        if(!state.imgReady) return;
        setCrosshair(state.pos.x, state.pos.y);
        sampleNow();
      }, {passive:true});
    }

    // ---------------- Locks UI
    function updateLocksUI(){
      const a = $("lockA"), b = $("lockB");
      a.classList.toggle("locked", state.A.locked);
      b.classList.toggle("locked", state.B.locked);
      a.textContent = state.A.locked ? "üîì D√©verrouiller A" : "üîí Verrouiller A";
      b.textContent = state.B.locked ? "üîì D√©verrouiller B" : "üîí Verrouiller B";
    }

    $("lockA").onclick = ()=>{
      state.A.locked = !state.A.locked;
      if(!state.A.locked){
        state.A.hex = state.sample.hex;
        state.A.rgb = {r:state.sample.r,g:state.sample.g,b:state.sample.b};
        state.A.name = state.sample.name;
      }
      updateLocksUI();
      renderSwatches();
    };

    $("lockB").onclick = ()=>{
      state.B.locked = !state.B.locked;
      if(!state.B.locked){
        state.B.hex = state.sample.hex;
        state.B.rgb = {r:state.sample.r,g:state.sample.g,b:state.sample.b};
        state.B.name = state.sample.name;
      }
      updateLocksUI();
      renderSwatches();
    };

    // ---------------- Mes couleurs modal
    function openColors(){
      renderColorsList({selectMode:false});
      openBD("bdColors");
    }
    $("btnColors").onclick = openColors;
    $("btnColors2").onclick = openColors;

    function renderColorsList({selectMode}){
      const list = $("colorsList");
      const saved = loadSaved();
      list.innerHTML = "";

      if(saved.length===0){
        list.innerHTML = `<div class="muted small">Aucune couleur sauvegard√©e pour le moment.</div>`;
        return;
      }

      saved.forEach((it, idx)=>{
        const el = document.createElement("div");
        el.className = "item";

        const sw = document.createElement("div");
        sw.className = "itemSw";
        sw.style.background = it.hex;

        const main = document.createElement("div");
        main.className = "itemMain";

        const t = document.createElement("p");
        t.className = "itemTitle";
        t.textContent = it.name;

        const sub = document.createElement("p");
        sub.className = "itemSub";
        sub.textContent = it.mode === "objets" ? "Objets" : "V√™tements";

        const meta = document.createElement("div");
        meta.className = "itemMeta";
        const d = new Date(it.ts);
        const rgb = it.rgb ? `RGB(${it.rgb.r},${it.rgb.g},${it.rgb.b})` : "";
        meta.textContent = `${it.hex} ‚Ä¢ ${rgb} ‚Ä¢ ${d.toLocaleDateString("fr-FR", { day:"2-digit", month:"short", year:"numeric" })}`;

        main.appendChild(t);
        main.appendChild(sub);
        main.appendChild(meta);

        const right = document.createElement("div");
        right.className = "itemRight";
        const del = document.createElement("button");
        del.type="button";
        del.textContent="Supprimer";
        del.onclick = ()=>{
          const arr = loadSaved();
          arr.splice(idx,1);
          saveSaved(arr);

          // also remove from compare selection if needed
          state.compare.selectedHex = state.compare.selectedHex.filter(h=>h!==it.hex);
          renderColorsList({selectMode});
          renderCompare();
        };
        right.appendChild(del);

        el.appendChild(sw);
        el.appendChild(main);
        el.appendChild(right);

        if(selectMode){
          const pill = document.createElement("div");
          pill.className = "selectPill";
          pill.innerHTML = `<span class="check"></span><span>S√©lectionner</span>`;
          const check = pill.querySelector(".check");

          const isOn = state.compare.selectedHex.includes(it.hex);
          if(isOn) check.classList.add("on");

          el.style.cursor = "pointer";
          el.onclick = ()=>{
            toggleCompareHex(it.hex);
            renderColorsList({selectMode:true});
            renderCompare();
          };

          el.appendChild(pill);
        }

        list.appendChild(el);
      });
    }

    $("resetAll").onclick = ()=>{
      if(confirm("Supprimer toutes les couleurs sauvegard√©es ?")){
        saveSaved([]);
        state.compare.selectedHex = [];
        renderColorsList({selectMode:false});
        renderCompare();
      }
    };

    // ---------------- Save button (unique, duo adds only missing)
    $("saveColors").onclick = ()=>{
      if(!state.A.hex || !state.B.hex){
        alert("Verrouille A et B avant de sauvegarder.");
        return;
      }

      const btn = $("saveColors");
      btn.classList.add("shimmer");
      setTimeout(()=>btn.classList.remove("shimmer"), 1200);

      const aHex = state.A.hex, bHex = state.B.hex;
      const aName = state.A.name, bName = state.B.name;
      const aRgb  = state.A.rgb,  bRgb  = state.B.rgb;

      if(aHex === bHex){
        if(addColorIfNew(aHex, aName, aRgb)){
          showToast("‚úÖ Couleur ajout√©e √† l‚Äôhistorique");
        } else {
          showToast("Couleur d√©j√† pr√©sente dans l‚Äôhistorique");
        }
        return;
      }

      const aNew = addColorIfNew(aHex, aName, aRgb);
      const bNew = addColorIfNew(bHex, bName, bRgb);

      if(!aNew && !bNew){
        showToast("Couleurs d√©j√† pr√©sentes dans l‚Äôhistorique");
      } else if(aNew && bNew){
        showToast("‚úÖ Couleurs ajout√©es √† l‚Äôhistorique");
      } else {
        showToast("Couleur d√©j√† pr√©sente dans l‚Äôhistorique");
      }
    };

    // ---------------- Compare feature
    function openCompare(){
      renderCompare();
      openBD("bdCompare");
    }
    $("btnCompare").onclick = openCompare;
    $("btnCompare2").onclick = openCompare;

    $("btnPickFromHistory").onclick = ()=>{
      // open "Mes couleurs" in selection mode
      openBD("bdColors");
      renderColorsList({selectMode:true});
    };

    $("btnClearSelection").onclick = ()=>{
      state.compare.selectedHex = [];
      renderCompare();
      renderColorsList({selectMode:true});
    };

    function toggleCompareHex(hex){
      const sel = state.compare.selectedHex;
      const idx = sel.indexOf(hex);

      if(idx >= 0){
        sel.splice(idx,1);
        return;
      }
      if(sel.length >= 4){
        showToast("S√©lection max : 4 couleurs");
        return;
      }
      sel.push(hex);
    }

    function getSavedByHex(hex){
      return loadSaved().find(x=>x.hex===hex);
    }

    // --- Color distance (Lab / DeltaE76) -> stable and perceptual
    function srgbToLinear(c){
      c /= 255;
      return (c <= 0.04045) ? (c/12.92) : Math.pow((c+0.055)/1.055, 2.4);
    }
    function rgbToXyz(r,g,b){
      const R = srgbToLinear(r);
      const G = srgbToLinear(g);
      const B = srgbToLinear(b);
      // sRGB D65
      const X = R*0.4124564 + G*0.3575761 + B*0.1804375;
      const Y = R*0.2126729 + G*0.7151522 + B*0.0721750;
      const Z = R*0.0193339 + G*0.1191920 + B*0.9503041;
      return {X, Y, Z};
    }
    function xyzToLab(X,Y,Z){
      // D65 reference white
      const Xn = 0.95047, Yn = 1.00000, Zn = 1.08883;
      let x = X/Xn, y = Y/Yn, z = Z/Zn;

      const f = (t)=> (t > 0.008856) ? Math.cbrt(t) : (7.787*t + 16/116);

      const fx = f(x), fy = f(y), fz = f(z);
      const L = 116*fy - 16;
      const a = 500*(fx - fy);
      const b = 200*(fy - fz);
      return {L,a,b};
    }
    function rgbToLab(r,g,b){
      const {X,Y,Z} = rgbToXyz(r,g,b);
      return xyzToLab(X,Y,Z);
    }
    function deltaE76(lab1, lab2){
      const dL = lab1.L - lab2.L;
      const da = lab1.a - lab2.a;
      const db = lab1.b - lab2.b;
      return Math.sqrt(dL*dL + da*da + db*db);
    }

    function proximityPercent(rgb1, rgb2){
      // ŒîE76 typical: 0 identical, ~2 barely noticeable, ~10 noticeable, ~20 big, ~40 huge
      const dE = deltaE76(rgbToLab(rgb1.r,rgb1.g,rgb1.b), rgbToLab(rgb2.r,rgb2.g,rgb2.b));
      // Map to 0..100 (best 100). We clamp at 60 for usability.
      const max = 60;
      const p = 100 * (1 - clamp(dE, 0, max)/max);
      return Math.round(p);
    }

    function labelForPercent(p){
      if(p >= 92) return "Ton sur ton";
      if(p >= 80) return "Tr√®s proche";
      if(p >= 65) return "Proche";
      return "Diff√©rent";
    }

    function renderCompare(){
      const selRow = $("selRow");
      const pairs = $("pairs");

      selRow.innerHTML = "";
      pairs.innerHTML = "";

      const sel = state.compare.selectedHex;
      if(sel.length === 0){
        selRow.innerHTML = `<div class="muted small">Aucune couleur s√©lectionn√©e. Clique sur ‚ÄúChoisir dans Mes couleurs‚Äù.</div>`;
        pairs.innerHTML = `<div class="muted small">S√©lectionne au moins 2 couleurs pour comparer.</div>`;
        return;
      }

      // chips
      sel.forEach((hex)=>{
        const it = getSavedByHex(hex);
        if(!it) return;
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = `
          <div class="chipSw" style="background:${it.hex}"></div>
          <div class="chipTxt">
            <div class="chipName">${it.name}</div>
            <div class="chipCode">${it.hex} ‚Ä¢ RGB(${it.rgb?.r ?? ""},${it.rgb?.g ?? ""},${it.rgb?.b ?? ""})</div>
          </div>
        `;
        chip.onclick = ()=>{
          toggleCompareHex(hex);
          renderCompare();
          renderColorsList({selectMode:true});
        };
        selRow.appendChild(chip);
      });

      if(sel.length < 2){
        pairs.innerHTML = `<div class="muted small">S√©lectionne au moins 2 couleurs pour comparer.</div>`;
        return;
      }

      // compute all pairs
      const entries = sel.map(h=>getSavedByHex(h)).filter(Boolean);
      const results = [];
      for(let i=0;i<entries.length;i++){
        for(let j=i+1;j<entries.length;j++){
          const a = entries[i], b = entries[j];
          const p = proximityPercent(a.rgb, b.rgb);
          results.push({a,b,p,label: labelForPercent(p)});
        }
      }
      results.sort((x,y)=>y.p - x.p);

      results.forEach((r)=>{
        const el = document.createElement("div");
        el.className = "pair";
        el.innerHTML = `
          <div class="pairL">
            <div class="miniSw" style="background:${r.a.hex}"></div>
            <div class="miniSw" style="background:${r.b.hex}"></div>
            <div>
              <div class="pairNames">${r.a.name} <span class="pairSmall">vs</span> ${r.b.name}</div>
              <div class="pairSmall">${r.a.hex} ‚Ä¢ ${r.b.hex}</div>
            </div>
          </div>
          <div class="badge"><b>${r.p}%</b> ‚Ä¢ ${r.label}</div>
        `;
        pairs.appendChild(el);
      });
    }

    // ---------------- Compare open from Mes couleurs (nice)
    function openColorsSelectMode(){
      openBD("bdColors");
      renderColorsList({selectMode:true});
    }

    // ---------------- Home compare button should work even without colors
    $("btnCompare").addEventListener("click", ()=>{
      if(loadSaved().length === 0){
        showToast("Ajoute d‚Äôabord des couleurs dans l‚Äôhistorique");
      }
    });

    // ---------------- Mes couleurs open from compare
    $("btnCompare2").addEventListener("click", ()=>{
      if(loadSaved().length === 0){
        showToast("Ajoute d‚Äôabord des couleurs dans l‚Äôhistorique");
      }
    });

    // ---------------- Compare button in modal should show selection helper
    $("btnPickFromHistory").addEventListener("click", ()=>{
      openColorsSelectMode();
    });

    // ---------------- Init UI
    function openColorsModal(){
      openColors();
    }

    // ---------------- Final hook buttons
    $("btnCompare").onclick = openCompare;
    $("btnCompare2").onclick = openCompare;

    // ---------------- Enable sampling + locks init
    updateLocksUI();
    enableTouchSampling();
  </script>
</body>
</html>