<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0711" />
  <title>ToneMatch AI</title>
  <style>
    :root{
      --bg0:#05030a;
      --bg1:#0b0711;
      --card:rgba(255,255,255,.07);
      --card2:rgba(255,255,255,.10);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --r:22px;
      --r2:16px;
      --pad:18px;
      --btnh:54px;
      --pink:#ff17b7;
      --violet:#7a2cff;
      --danger:#ff4b4b;
      --ok:#2ee59d;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1100px 650px at 25% 15%, rgba(255,23,183,.22), transparent 55%),
        radial-gradient(950px 650px at 75% 30%, rgba(122,44,255,.22), transparent 55%),
        radial-gradient(900px 650px at 50% 80%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100%;
      padding: calc(16px + var(--safe-top)) 14px calc(18px + var(--safe-bottom));
    }

    .wrap{max-width:980px;margin:0 auto}
    .topbar{
      display:flex;align-items:center;gap:10px;
      padding:12px 8px 18px;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2) 22%, transparent 35%),
                  linear-gradient(135deg, var(--pink), var(--violet));
      box-shadow:0 0 24px rgba(255,23,183,.45);
    }
    .brand{font-weight:800;letter-spacing:.2px;font-size:18px}
    .spacer{flex:1}
    .seg{
      display:inline-flex;border:1px solid var(--stroke);
      border-radius:999px;overflow:hidden;
      background:rgba(255,255,255,.04);
    }
    .seg button{
      height:34px;padding:0 12px;border:0;background:transparent;color:var(--muted);
      font-weight:700;font-size:13px;
    }
    .seg button.on{
      color:var(--text);
      background:linear-gradient(135deg, rgba(255,23,183,.35), rgba(122,44,255,.35));
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: var(--pad);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .hero{
      display:grid;gap:12px;
      padding:22px;
    }
    .title{font-size:38px;line-height:1.02;margin:0;font-weight:900;letter-spacing:-.6px}
    .sub{margin:0;color:var(--muted);font-size:15px;line-height:1.4}

    .actions{display:grid;gap:10px;margin-top:8px}
    .btn{
      height:var(--btnh);
      width:100%;
      border:0;
      border-radius: 16px;
      font-weight:900;
      font-size:16px;
      color:white;
      background: rgba(255,255,255,.08);
      border:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:center;
      gap:10px;
    }
    .btn.primary{
      background: linear-gradient(90deg, var(--pink), var(--violet));
      border:0;
      box-shadow: 0 14px 45px rgba(255,23,183,.22);
    }
    .btn.danger{
      background: rgba(255,75,75,.18);
      border:1px solid rgba(255,75,75,.35);
      color:#ffd6d6;
    }
    .btn:active{transform:translateY(1px)}

    .stage{
      margin-top:14px;
      display:none;
      gap:12px;
    }

    .imgCard{
      padding:14px;
      display:grid;gap:10px;
    }
    .imgWrap{
      border-radius:18px;
      border:1px solid var(--stroke);
      overflow:hidden;
      background:rgba(255,255,255,.04);
      position:relative;
      aspect-ratio: 4 / 3;
      display:flex;align-items:center;justify-content:center;
      touch-action:none; /* IMPORTANT: allow custom drag on iOS */
      user-select:none;
    }
    .imgWrap img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
      pointer-events:none; /* drag events go to wrap */
    }
    .imgWrap .overlayHint{
      position:absolute;inset:0;
      pointer-events:none;
    }
    /* Crosshair: movable + precise */
    .crosshair{
      position:absolute;
      width:34px;height:34px;
      left:50%;top:50%;
      transform:translate(-50%,-50%);
      border:2px solid rgba(255,255,255,.90);
      border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.45);
      background:transparent;
    }
    .crosshair:before,.crosshair:after{
      content:"";
      position:absolute;left:50%;top:50%;
      width:26px;height:2px;background:rgba(255,255,255,.90);
      transform:translate(-50%,-50%);
      border-radius:2px;
    }
    .crosshair:after{width:2px;height:26px;}

    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .row .btn{flex:1;min-width:210px}

    .swatchPanel{
      border-radius:18px;
      border:1px solid var(--stroke);
      overflow:hidden;
      background:rgba(0,0,0,.18);
    }
    .swRow{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;
      font-weight:900;
    }
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      font-size:13px;font-weight:900;
      color:rgba(255,255,255,.92);
    }
    .dotMini{width:12px;height:12px;border-radius:4px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.15)}
    .hexSmall{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-weight:800;color:rgba(255,255,255,.9);font-size:13px}
    .centerHex{
      padding:18px 12px;
      text-align:center;
      font-size:42px;
      font-weight:1000;
      letter-spacing:1px;
      text-shadow:0 18px 50px rgba(0,0,0,.55);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .swSplit{display:grid;grid-template-rows:auto auto auto;}
    .swA{background:rgba(255,255,255,.04)}
    .swCenter{background:rgba(0,0,0,.10)}
    .swB{background:rgba(255,255,255,.04)}
    .barBtns{
      display:flex;gap:10px;
      padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
      flex-wrap:wrap;
    }
    .barBtns .btn{min-width:220px}
    .btn.locked{
      background:rgba(46,229,157,.14);
      border:1px solid rgba(46,229,157,.30);
      color:#dcfff3;
    }

    /* Modal */
    .backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      padding: 12px 12px calc(12px + var(--safe-bottom));
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:760px;
      margin:0 auto;
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead h3{margin:0;font-size:18px;font-weight:1000}
    .x{
      width:40px;height:40px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:18px;font-weight:1000;
    }
    .modalBody{padding:14px 16px 16px}
    .sheetBtns{display:grid;gap:10px}

    /* Mes couleurs list */
    .list{
      display:grid;gap:12px;
      max-height: 60vh;
      overflow:auto;
      padding-right:6px;
    }
    .item{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      min-height:106px;
    }
    .itemSw{
      width:120px;min-width:120px;
      display:flex;flex-direction:column;
    }
    .itemSw .half{flex:1}
    .itemMain{
      flex:1;
      padding:12px 12px;
      display:flex;flex-direction:column;gap:6px;
      justify-content:center;
    }
    .itemTitle{font-weight:1000;font-size:18px;line-height:1.1;margin:0}
    .itemSub{margin:0;color:var(--muted);font-weight:800;font-size:13px}
    .itemMeta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted2);font-weight:800;font-size:12px}
    .itemRight{
      display:flex;align-items:center;justify-content:center;
      padding:12px;
      width:120px;min-width:120px;
      border-left:1px solid rgba(255,255,255,.10);
      background:rgba(255,75,75,.10);
    }
    .itemRight button{
      height:40px;width:100%;
      border-radius:14px;
      border:1px solid rgba(255,75,75,.30);
      background:rgba(255,75,75,.18);
      color:#ffd6d6;
      font-weight:1000;
    }

    .muted{color:var(--muted)}
    .small{font-size:13px}
    .hide{display:none!important}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <span class="dot"></span>
      <div class="brand">ToneMatch <span class="muted">AI</span></div>
      <div class="spacer"></div>

      <div class="seg" id="modeSeg" title="Mode d‚Äôusage">
        <button type="button" data-mode="vetements" class="on">V√™tements</button>
        <button type="button" data-mode="objets">Objets</button>
      </div>
    </div>

    <!-- HOME -->
    <div class="card hero" id="home">
      <h1 class="title">Identifiez vos couleurs</h1>
      <p class="sub">
        Prenez une photo ou importez une image. D√©placez la cible pour pr√©lever.
        Verrouillez A et B, puis sauvegardez dans <b>Mes couleurs</b>.
      </p>

      <div class="actions">
        <button class="btn primary" id="btnPick">üì∏ <span>Prendre / importer une image</span></button>
        <button class="btn" id="btnColors">üé® <span>Mes couleurs</span></button>
      </div>
    </div>

    <!-- STAGE -->
    <div class="stage" id="stage">
      <div class="card imgCard">
        <div class="imgWrap" id="imgWrap">
          <img id="img" alt="Image s√©lectionn√©e" />
          <div class="overlayHint">
            <div class="crosshair" id="crosshair"></div>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnChangeImg">üñºÔ∏è Changer d‚Äôimage</button>
          <button class="btn" id="btnColors2">üé® Mes couleurs</button>
        </div>

        <div class="swatchPanel" id="swatchPanel">
          <div class="swSplit">
            <div class="swRow swA" id="rowA">
              <div class="tag"><span class="dotMini" id="dotA"></span> A <span class="muted" id="nameA">‚Äî</span></div>
              <div class="hexSmall" id="hexA">‚Äî</div>
            </div>

            <div class="swCenter" id="rowCenter">
              <div class="centerHex" id="hexCenter">‚Äî</div>
            </div>

            <div class="swRow swB" id="rowB">
              <div class="tag"><span class="dotMini" id="dotB"></span> B <span class="muted" id="nameB">‚Äî</span></div>
              <div class="hexSmall" id="hexB">‚Äî</div>
            </div>
          </div>

          <div class="barBtns">
            <button class="btn" id="lockA">üîí Verrouiller A</button>
            <button class="btn" id="lockB">üîí Verrouiller B</button>
            <button class="btn primary" id="saveColors">üíæ Sauvegarder dans Mes couleurs</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FILE INPUTS -->
  <input id="inCamera" type="file" accept="image/*" capture="environment" class="hide" />
  <input id="inPhotos" type="file" accept="image/*" class="hide" />
  <input id="inFiles" type="file" accept="image/*" class="hide" />

  <!-- MODAL: Choisir source -->
  <div class="backdrop" id="bdPick">
    <div class="modal">
      <div class="modalHead">
        <h3>Choisir une source</h3>
        <button class="x" type="button" data-close="bdPick">√ó</button>
      </div>
      <div class="modalBody">
        <div class="sheetBtns">
          <button class="btn primary" type="button" id="pickCamera">üì∏ Cam√©ra</button>
          <button class="btn" type="button" id="pickPhotos">üñºÔ∏è Photos / Galerie</button>
          <button class="btn" type="button" id="pickFiles">üìÅ Fichiers</button>
        </div>
        <p class="small muted" style="margin:12px 2px 0">
          Astuce iPhone : ‚ÄúPhotos / Galerie‚Äù ouvre ton album, ‚ÄúFichiers‚Äù ouvre iCloud/Drive.
        </p>
      </div>
    </div>
  </div>

  <!-- MODAL: Mes couleurs -->
  <div class="backdrop" id="bdColors">
    <div class="modal">
      <div class="modalHead">
        <h3>Mes couleurs</h3>
        <button class="x" type="button" data-close="bdColors">√ó</button>
      </div>
      <div class="modalBody">
        <p class="small muted" style="margin-top:0">
          Ici tu retrouves tes couleurs sauvegard√©es. Simple, propre, et supprimable.
        </p>
        <div class="list" id="colorsList"></div>
        <div style="margin-top:12px">
          <button class="btn danger" id="resetAll">üóëÔ∏è Tout supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <canvas id="cv" class="hide"></canvas>

  <script>
    const $ = (id)=>document.getElementById(id);

    const state = {
      mode: "vetements",
      imgEl: $("img"),
      imgReady: false,
      // crosshair position inside wrap (0..1)
      target: { nx: 0.5, ny: 0.5 },
      // sampled pixel
      sample: { r:0,g:0,b:0, hex:"#000000", name:"‚Äî" },
      A: { locked:false, hex:null, name:null, rgb:null },
      B: { locked:false, hex:null, name:null, rgb:null },
      // cached canvas for fast sampling
      draw: { scale: 1, w:0, h:0 },
    };

    // LocalStorage
    const LS_KEY = "tonematch_mes_couleurs_v3";
    const loadSaved = ()=> {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
      catch { return []; }
    };
    const saveSaved = (arr)=> localStorage.setItem(LS_KEY, JSON.stringify(arr));

    // Modal helpers
    function openBD(id){ $(id).style.display="flex"; }
    function closeBD(id){ $(id).style.display="none"; }
    document.addEventListener("click",(e)=>{
      const btn = e.target.closest("[data-close]");
      if(btn) closeBD(btn.getAttribute("data-close"));
      if(e.target.classList.contains("backdrop")) e.target.style.display="none";
    });

    // Mode selector
    $("modeSeg").addEventListener("click",(e)=>{
      const b = e.target.closest("button[data-mode]");
      if(!b) return;
      state.mode = b.dataset.mode;
      [...$("modeSeg").querySelectorAll("button")].forEach(x=>x.classList.toggle("on", x===b));
    });

    // Picker modal
    function openPicker(){ openBD("bdPick"); }
    $("btnPick").onclick = openPicker;
    $("btnChangeImg").onclick = openPicker;

    $("pickCamera").onclick = ()=>{ closeBD("bdPick"); $("inCamera").click(); };
    $("pickPhotos").onclick = ()=>{ closeBD("bdPick"); $("inPhotos").click(); };
    $("pickFiles").onclick  = ()=>{ closeBD("bdPick"); $("inFiles").click(); };

    // Inputs
    async function onFilePicked(file, inputEl){
      if(!file) return;

      // reset input so picking same image twice still triggers change
      if(inputEl) inputEl.value = "";

      const url = URL.createObjectURL(file);
      state.imgEl.src = url;

      $("home").style.display = "none";
      $("stage").style.display = "grid";

      state.imgEl.onload = ()=>{
        state.imgReady = true;

        // reset locks on new image
        state.A.locked = false; state.B.locked=false;
        state.A.hex = null; state.B.hex=null;
        updateLocksUI();

        // default target center
        setTarget(0.5, 0.5, true);

        // build cached canvas for sampling
        buildSamplingCanvas();

        // sample now
        sampleNow();
      };
    }

    $("inCamera").addEventListener("change",(e)=> onFilePicked(e.target.files?.[0], e.target));
    $("inPhotos").addEventListener("change",(e)=> onFilePicked(e.target.files?.[0], e.target));
    $("inFiles").addEventListener("change",(e)=> onFilePicked(e.target.files?.[0], e.target));

    // ---- Sampling helpers (object-fit: cover mapping)
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    function getDisplayedImageRect(img){
      const wrap = $("imgWrap");
      const W = wrap.clientWidth, H = wrap.clientHeight;
      const iw = img.naturalWidth, ih = img.naturalHeight;
      const scale = Math.max(W/iw, H/ih);
      const dw = iw*scale, dh = ih*scale;
      const dx = (W - dw)/2;
      const dy = (H - dh)/2;
      return {W,H,iw,ih,scale,dw,dh,dx,dy};
    }

    function buildSamplingCanvas(){
      const img = state.imgEl;
      const rect = getDisplayedImageRect(img);
      const cv = $("cv");
      const ctx = cv.getContext("2d", { willReadFrequently:true });

      // downscale for speed (still accurate enough)
      const maxW = 1400;
      const s = Math.min(1, maxW / rect.iw);
      const tw = Math.max(1, Math.round(rect.iw * s));
      const th = Math.max(1, Math.round(rect.ih * s));

      cv.width = tw; cv.height = th;
      ctx.clearRect(0,0,tw,th);
      ctx.drawImage(img, 0,0, tw,th);

      state.draw.scale = s;
      state.draw.w = tw;
      state.draw.h = th;
    }

    function sampleAtNormalized(nx, ny){
      const img = state.imgEl;
      if(!state.imgReady) return null;

      const rect = getDisplayedImageRect(img);
      const cx = rect.W * nx;
      const cy = rect.H * ny;

      // map to natural image coords
      const sx = (cx - rect.dx) / rect.scale;
      const sy = (cy - rect.dy) / rect.scale;

      const x = Math.round(clamp(sx, 0, rect.iw-1));
      const y = Math.round(clamp(sy, 0, rect.ih-1));

      const cv = $("cv");
      const ctx = cv.getContext("2d", { willReadFrequently:true });

      const s = state.draw.scale || 1;
      const rx = Math.round(clamp(x * s, 0, cv.width-1));
      const ry = Math.round(clamp(y * s, 0, cv.height-1));

      const data = ctx.getImageData(rx, ry, 1, 1).data;
      return {r:data[0], g:data[1], b:data[2]};
    }

    function rgbToHex(r,g,b){
      const to = (n)=> n.toString(16).padStart(2,"0").toUpperCase();
      return "#"+to(r)+to(g)+to(b);
    }

    function rgbToHsl(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h=0,s=0,l=(max+min)/2;
      const d=max-min;
      if(d!==0){
        s = d/(1-Math.abs(2*l-1));
        switch(max){
          case r: h=((g-b)/d)%6; break;
          case g: h=((b-r)/d)+2; break;
          case b: h=((r-g)/d)+4; break;
        }
        h*=60; if(h<0) h+=360;
      }
      return {h, s, l};
    }

    // Friendly FR naming (no ‚Äúteinte unique‚Äù)
    function colorNameFR(hex, r,g,b){
      const {h,s,l} = rgbToHsl(r,g,b);
      const sat = s, light = l;
      const nearGray = sat < 0.10;

      if(nearGray){
        if(light > 0.93) return "Blanc neige";
        if(light > 0.86) return "Blanc cass√©";
        if(light > 0.74) return "Gris perle";
        if(light > 0.62) return "Gris clair";
        if(light > 0.48) return "Gris fum√©";
        if(light > 0.34) return "Anthracite";
        if(light > 0.18) return "Noir profond";
        return "Noir absolu";
      }

      const hue = h;
      const inRange = (a,b)=> (a<=b) ? (hue>=a && hue<b) : (hue>=a || hue<b);

      let base = "Couleur";
      if(inRange(345, 15)) base = "Rouge";
      else if(inRange(15, 35)) base = "Orange";
      else if(inRange(35, 58)) base = "Jaune";
      else if(inRange(58, 95)) base = "Vert";
      else if(inRange(95, 150)) base = "Turquoise";
      else if(inRange(150, 210)) base = "Bleu";
      else if(inRange(210, 255)) base = "Indigo";
      else if(inRange(255, 290)) base = "Violet";
      else if(inRange(290, 345)) base = "Fuchsia";

      // Beige-like
      if((inRange(20,65)) && sat < 0.35 && light > 0.65){
        if(light>0.82) return "Cr√®me";
        if(light>0.72) return "Beige sable";
        return "Caramel doux";
      }

      // Classics
      if(base==="Rouge" && sat>0.65) return "Rouge passion";
      if(base==="Rouge" && light<0.35) return "Bordeaux";
      if(base==="Orange" && sat>0.65 && light<0.55) return "Orange √©pic√©";
      if(base==="Jaune" && light>0.78) return "Jaune solaire";
      if(base==="Vert" && light<0.35) return "Vert sapin";
      if(base==="Bleu" && light<0.32) return "Bleu nuit";
      if(base==="Bleu" && sat>0.55 && light>0.45) return "Bleu royal";
      if(base==="Violet" && light<0.45) return "Prune";

      // Qualifier
      let q = "";
      if(light > 0.82 && sat < 0.35) q = "pastel";
      else if(sat < 0.28) q = "poudr√©";
      else if(sat > 0.70) q = "vif";
      else q = "chic";

      if(q==="pastel") return base + " pastel";
      if(q==="poudr√©") return base + " poudr√©";
      if(q==="vif") return base + " vif";
      return base + " chic";
    }

    function setTarget(nx, ny, immediate){
      state.target.nx = clamp(nx, 0, 1);
      state.target.ny = clamp(ny, 0, 1);

      const wrap = $("imgWrap");
      const x = wrap.clientWidth  * state.target.nx;
      const y = wrap.clientHeight * state.target.ny;

      const ch = $("crosshair");
      ch.style.left = x + "px";
      ch.style.top  = y + "px";

      if(immediate) sampleNow();
    }

    function sampleNow(){
      const rgb = sampleAtNormalized(state.target.nx, state.target.ny);
      if(!rgb) return;

      const hex = rgbToHex(rgb.r,rgb.g,rgb.b);
      const name = colorNameFR(hex, rgb.r,rgb.g,rgb.b);

      state.sample = { ...rgb, hex, name };

      if(!state.A.locked){
        state.A.hex = hex; state.A.rgb = rgb; state.A.name = name;
      }
      if(!state.B.locked){
        state.B.hex = hex; state.B.rgb = rgb; state.B.name = name;
      }

      renderSwatches();
    }

    function renderSwatches(){
      // Center EXACT sampled color
      $("hexCenter").textContent = state.sample.hex;
      $("rowCenter").style.background = state.sample.hex;

      // A
      $("hexA").textContent = state.A.hex || "‚Äî";
      $("nameA").textContent = state.A.name || "‚Äî";
      $("rowA").style.background = state.A.hex || "rgba(255,255,255,.04)";
      $("dotA").style.background = state.A.hex || "rgba(255,255,255,.15)";

      // B
      $("hexB").textContent = state.B.hex || "‚Äî";
      $("nameB").textContent = state.B.name || "‚Äî";
      $("rowB").style.background = state.B.hex || "rgba(255,255,255,.04)";
      $("dotB").style.background = state.B.hex || "rgba(255,255,255,.15)";

      // readable text on center
      const lum = (rgb)=> (0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b)/255;
      $("hexCenter").style.color = (lum(state.sample) > 0.62)
        ? "rgba(0,0,0,.78)"
        : "rgba(255,255,255,.92)";
    }

    // Drag / click sampling on image
    function enableTouchSampling(){
      const wrap = $("imgWrap");
      let dragging = false;

      const toLocal = (clientX, clientY)=>{
        const r = wrap.getBoundingClientRect();
        const x = clamp(clientX - r.left, 0, r.width);
        const y = clamp(clientY - r.top,  0, r.height);
        return { nx: (r.width ? x/r.width : 0.5), ny: (r.height ? y/r.height : 0.5) };
      };

      // Pointer events work on iOS Safari too (modern)
      wrap.addEventListener("pointerdown", (e)=>{
        if(!state.imgReady) return;
        dragging = true;
        wrap.setPointerCapture?.(e.pointerId);
        const p = toLocal(e.clientX, e.clientY);
        setTarget(p.nx, p.ny, true);
      });

      wrap.addEventListener("pointermove", (e)=>{
        if(!dragging || !state.imgReady) return;
        const p = toLocal(e.clientX, e.clientY);
        setTarget(p.nx, p.ny, true);
      });

      wrap.addEventListener("pointerup", ()=>{
        dragging = false;
      });

      // Also refresh on resize (keeps target correct)
      window.addEventListener("resize", ()=>{
        if(!state.imgReady) return;
        setTarget(state.target.nx, state.target.ny, true);
      }, {passive:true});
    }

    function updateLocksUI(){
      const a = $("lockA"), b = $("lockB");
      a.classList.toggle("locked", state.A.locked);
      b.classList.toggle("locked", state.B.locked);
      a.textContent = state.A.locked ? "üîì D√©verrouiller A" : "üîí Verrouiller A";
      b.textContent = state.B.locked ? "üîì D√©verrouiller B" : "üîí Verrouiller B";
    }

    $("lockA").onclick = ()=>{
      state.A.locked = !state.A.locked;
      if(!state.A.locked){
        state.A.hex = state.sample.hex;
        state.A.rgb = {r:state.sample.r,g:state.sample.g,b:state.sample.b};
        state.A.name = state.sample.name;
      }
      updateLocksUI();
      renderSwatches();
    };

    $("lockB").onclick = ()=>{
      state.B.locked = !state.B.locked;
      if(!state.B.locked){
        state.B.hex = state.sample.hex;
        state.B.rgb = {r:state.sample.r,g:state.sample.g,b:state.sample.b};
        state.B.name = state.sample.name;
      }
      updateLocksUI();
      renderSwatches();
    };

    // Mes couleurs modal
    function openColors(){
      renderColorsList();
      openBD("bdColors");
    }
    $("btnColors").onclick = openColors;
    $("btnColors2").onclick = openColors;

    function keyForEntry(entry){
      if(entry.type==="single") return "S:"+entry.a.hex+"|"+entry.mode;
      return "P:"+entry.a.hex+"|"+entry.b.hex+"|"+entry.mode;
    }

    function renderColorsList(){
      const list = $("colorsList");
      const saved = loadSaved();
      list.innerHTML = "";

      if(saved.length===0){
        list.innerHTML = `<div class="muted small">Aucune couleur sauvegard√©e pour le moment.</div>`;
        return;
      }

      saved.forEach((it, idx)=>{
        const el = document.createElement("div");
        el.className = "item";

        const sw = document.createElement("div");
        sw.className = "itemSw";

        const half1 = document.createElement("div");
        half1.className = "half";
        half1.style.background = it.a.hex;

        const half2 = document.createElement("div");
        half2.className = "half";
        half2.style.background = (it.type==="pair") ? it.b.hex : it.a.hex;

        sw.appendChild(half1);
        sw.appendChild(half2);

        const main = document.createElement("div");
        main.className = "itemMain";

        const t = document.createElement("p");
        t.className = "itemTitle";
        t.textContent = (it.type==="single")
          ? it.a.name
          : `${it.a.name} + ${it.b.name}`;

        const sub = document.createElement("p");
        sub.className = "itemSub";
        sub.textContent = (it.mode === "objets") ? "Objets" : "V√™tements";

        const meta = document.createElement("div");
        meta.className = "itemMeta";
        const d = new Date(it.ts);
        meta.textContent = d.toLocaleDateString("fr-FR", { day:"2-digit", month:"short", year:"numeric" });

        main.appendChild(t);
        main.appendChild(sub);
        main.appendChild(meta);

        const right = document.createElement("div");
        right.className = "itemRight";

        const del = document.createElement("button");
        del.type="button";
        del.textContent="Supprimer";
        del.onclick = ()=>{
          const arr = loadSaved();
          arr.splice(idx,1);
          saveSaved(arr);
          renderColorsList();
        };

        right.appendChild(del);

        el.appendChild(sw);
        el.appendChild(main);
        el.appendChild(right);

        list.appendChild(el);
      });
    }

    $("resetAll").onclick = ()=>{
      if(confirm("Supprimer toutes les couleurs sauvegard√©es ?")){
        saveSaved([]);
        renderColorsList();
      }
    };

    // Save
    $("saveColors").onclick = ()=>{
      if(!state.A.hex || !state.B.hex){
        alert("Verrouille A et B avant de sauvegarder.");
        return;
      }

      const same = (state.A.hex === state.B.hex);

      const entry = same ? {
        type:"single",
        mode: state.mode,
        ts: Date.now(),
        a:{ hex: state.A.hex, name: state.A.name }
      } : {
        type:"pair",
        mode: state.mode,
        ts: Date.now(),
        a:{ hex: state.A.hex, name: state.A.name },
        b:{ hex: state.B.hex, name: state.B.name },
      };

      const saved = loadSaved();
      const k = keyForEntry(entry);
      const exists = saved.some(x=> keyForEntry(x)===k);

      if(!exists){
        saved.unshift(entry);
        saveSaved(saved.slice(0, 120));
      }

      openColors();
    };

    // Init
    updateLocksUI();
    enableTouchSampling();
  </script>
</body>
</html>